--- 
title: "Section 1.2 TB mortality" 
author: "Mathieu Bastard, reformatted/refactored by Hazim Timimi" 
date: "`r Sys.Date()`" 
knit: (function(inputFile, encoding) {
      out_dir <- "./local";
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_dir=file.path(dirname(inputFile), out_dir))})
output:  
  html_fragment: 
    # Don’t include a table of contents 
    toc: no 
    # Set standard figure width to 12 inches 
    fig_width: 12 
    # Don’t write figure captions 
    fig_caption: FALSE 
    # Don't embed external resources (stylesheets, JS libraries) in the output 
    self_contained: FALSE 
    # Don't include <div> tags around a header and the content found until the next header
    section_divs: FALSE  


# To run this file and store output as html:
# rmarkdown::render(here::here("report/ch1-2.rmd"), output_file = "ch1-2.html", output_dir = here::here("report/local/"))
--- 



```{r setup, include=FALSE} 
# Chapter 1
# Set options, load data, utility functions 

knitr::opts_chunk$set(echo = FALSE,  
                      results = "asis", 
                      message = FALSE, 
                      warning = FALSE,
                      error = TRUE)  # TEMP error=TRUE for debugging!

# Kill any attempt at using factors, unless we explicitly want them!
options(stringsAsFactors=FALSE)
options(scipen=999)

# Set output options ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

# Show static chart in addition to Kendo chart?
show_static = FALSE

# Save underlying data files as CSV and charts as PDF files?
pdf_csv_folder = here::here("report/local/figures/ch1-2")
save_csv = TRUE
save_pdf = TRUE

# Create the output folder (only if it doesn't yet exist)
dir.create(pdf_csv_folder, showWarnings = FALSE, recursive = TRUE)

# Load output packages ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

library(data.table)
library(gtbreport)
library(here)
library(kableExtra)
library(gridExtra)
library(whomap)
library(ggpubr)
library(productplots)
library(RColorBrewer)
library(tidyverse)
library(jsonlite)
library(dplyr)


# Load R functions ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

source(here("report/functions/html_links.R"))
source(here("report/functions/output_ggplot.R"))

# Prepare data for the chapter
source(here('report/ch1_prepare_data.R'))

``` 

```{r css_js}
# Add standard stylesheets and javascript to support kendo
cat(writeLines(readLines(here("report/resources/headers.htm"))))
```

```{css, echo=FALSE}

/* Table 1.2.1 */
/* Recreating simple striped bootstrap table */
#burden_num_table {
  border-spacing: 0;
  border-collapse: collapse;
  margin-top: 1em;
  margin-bottom: 1em;
  /* Next two lines to allow horizontal scrolling on narrow screens */
  display: block;
  overflow-x: auto;
}

#burden_num_table th {
  border-bottom: 2px solid #DDDDDD;
  padding: 8px;
}

#burden_num_table td {
  border-top: 1px solid #DDDDDD;
  padding: 8px;
}

/* light gray for odd rows */
#burden_num_table tr:nth-child(odd) td {
  background-color: #F5F5F5;	
}

/* Bold for the final row with thick line above */
#burden_num_table tr:last-child td {
  border-top: 2px solid #DDDDDD;
  font-weight:bold;	
}

/* light gray when hovering over a row */
#burden_num_table tr:hover td {
  background-color: #DDDDDD;
}

/* Centre-align all column headings except for the first */
#burden_num_table th:not(:first-child) {
  text-align: center !important;
}

/* prevent numbers from wrapping in any of the columns */
#burden_num_table td {
  white-space: nowrap;
}


```

```{r}
# to format 100 000 as a R object, avoid breaking lines
cm=formatC(1e5, format="f", big.mark=" ", digits=0)

```



# 1.2 TB mortality

_Draft! Prepared `r Sys.Date()` using country-reported data snapshot files from `r snapshot_date` and incidence estimates from `r est_date`_


`r lnk("Box 1.2.1")` summarizes the methods used to produce estimates of TB mortality between 2010 and 2019, and the new methods that were needed to produce estimates for 2020–2022. Estimation of TB mortality during the COVID-19 pandemic and its aftermath is much more difficult than previously. The new methods were extensively reviewed in 2021 and 2022, but rely heavily on country and region-specific dynamic models for low and middle-income countries that experienced major COVID-related disruptions to TB diagnosis and treatment, in the absence of reliable and up-to-date mortality data from national vital registration (VR) systems that include coding of causes of death according to international standards (`r ref_lnk("1")`). Only two of the 30 high TB burden countries (Brazil and China) and one of the global TB watchlist countries (the Russian Federation) reported data to WHO on the number of deaths caused by TB for the period 2020–2022, based on national VR data.  

For consistency with international standards (`r ref_lnk("1")`), this section makes a clear distinction between deaths from TB in people without HIV (classified as deaths caused by TB) and deaths from TB in people with HIV (classified as deaths caused by HIV, with TB as a contributory cause).  

Globally, the annual number of deaths caused by TB fell between 2010 and 2019, but this trend was reversed in 2020 and 2021  (`r lnk("Fig. 1.2.1")`). The estimated increase in the number of deaths caused by TB in these two years was the consequence of disruptions to TB diagnosis and treatment during the COVID-19 pandemic, when the reported number of people newly diagnosed with TB fell from `r round(global$c.newinc[global$year==2019]/1e6,1)` million in 2019 to `r round(global$c.newinc[global$year==2020]/1e6,1)` million in 2020 and `r round(global$c.newinc[global$year==2021]/1e6,1)` million in 2021 (<span class="red">Section 2.1</span>), suggesting a large increase in the number of people with undiagnosed and untreated TB. The estimated decrease in the number of deaths caused by TB in 2022 (a `r 100-round(100*global$mort.num[global$year==2022]/global$mort.num[global$year==2021],1) `% reduction compared with 2021) reflects the big global recovery in the number of people newly diagnosed with TB in 2022 (<span class="red">Section 2.1</span>).

Globally in 2022, there were an estimated `r round(global$mort.nh.num[global$year==2022]/1e6,2)` million deaths among HIV-negative people (95% uncertainty interval [UI]: `r round(global$mort.nh.lo.num[global$year==2022]/1e6,2)`–`r round(global$mort.nh.hi.num[global$year==2022]/1e6,2)` million) and an estimated `r thous(round(global$mort.h.num[global$year==2022]/1e3,0))` deaths among people with HIV (95% UI: `r thous(round(global$mort.h.lo.num[global$year==2022]/1e3,0))`–`r thous(round(global$mort.h.hi.num[global$year==2022]/1e3,0))`). The combined total of `r round(global$mort.num[global$year==2022]/1e6,2)` million is almost back to the level of 2019. However, the net reduction in the total number of deaths caused by TB between 2015 and 2022 was only `r 100-round(100*global$mort.num[global$year==2022]/global$mort.num[global$year==2015],0)`%, far from the 2025 milestone of the End TB Strategy (a 75% reduction between 2015 and 2025).


### `r anch("Fig. 1.2.1")`<span class="red">Fig. 1.2.1</span> Global trends in the estimated number of deaths caused by TB (a) and the TB mortality rate(b), 2010&#8211;2022
<div class="subhead">Shaded areas represent 95% uncertainty intervals. The horizontal dashed line shows the 2025 milestone of the End TB Strategy, which is a 75% reduction in the total number of deaths caused by TB between 2015 and 2025.</div>

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig_1.2.1, fig.alt="Global trends in the estimated number of TB deaths (left) and the mortality rate (right), 2010-2022"}

f1.2.1a_plot <-
  qplot(
    year,
    mort.num / 1e6,
    data = subset(global,year>=2010),
    geom = 'line',
    colour = I('grey20')
  ) +
  geom_ribbon(
    aes(year, ymin = mort.lo.num / 1e6, ymax = mort.hi.num / 1e6),
    fill = I('grey40'),
    alpha = 0.4
  ) +
  ylab('Millions per year') + xlab('') +
  geom_line(aes(year, mort.h.num / 1e6), colour = I('lightskyblue2')) +
  geom_ribbon(
    aes(year, ymin = mort.h.lo.num / 1e6, ymax = mort.h.hi.num / 1e6),
    fill = I('lightskyblue2'),
    alpha = 0.4
  ) +
  geom_line(aes(year, mort.nh.num / 1e6), colour = I('blue')) +
  geom_ribbon(
    aes(year, ymin = mort.nh.lo.num / 1e6, ymax = mort.nh.hi.num / 1e6),
    fill = I('blue'),
    alpha = 0.4
  ) +
  geom_line(aes(year, mort.num / 1e6), colour = I('grey20')) +
  geom_ribbon(
    aes(year, ymin = mort.lo.num / 1e6, ymax = mort.hi.num / 1e6),
    fill = I('grey40'),
    alpha = 0.4
  ) +
  annotate(
    'text',
    y = 0.6,
    x = 2013,
    label = '2025 milestone',
    hjust = 0,
    size = I(4)
  ) +
#  expand_limits(y = 0.1) +
  geom_hline(aes(yintercept = global$mort.num[global$year==2015] * 0.25 / 1e6), linetype = I(2)) +
  annotate(
    'text',
    x = 2013,
    y = 2,
    label = 'Total',
    hjust = 0,
    size = I(4)
  ) +
  annotate(
    'text',
    x = 2013,
    y = 1.2,
    label = 'People without HIV people',
    hjust = 0,
    size = I(4)
  ) +
  annotate(
    'text',
    x = 2013,
    y = 0.20,
    label = 'People with HIV people',
    hjust = 0,
    size = I(4)
  ) +
 # scale_y_log10() +
  scale_x_continuous(breaks=c(2010,2015,2020)) +
  theme_gtb() + theme(legend.position = 'none')

output_ggplot(f1.2.1a_plot, global[, .(year, mort.num, mort.lo.num, mort.hi.num, mort.nh.num, mort.nh.lo.num, mort.nh.hi.num, mort.h.num, mort.h.lo.num, mort.h.hi.num, milestone=mort.num[16] * 0.65)], show_static, pdf_csv_folder, save_csv, save_pdf)

f1.2.1b_plot <-
  qplot(
    year,
    mort,
    data = subset(global,year>=2010),
    geom = 'line',
    colour = I('grey20')
  ) +
  geom_ribbon(aes(year, ymin = mort.lo, ymax = mort.hi),
              fill = I('grey40'),
              alpha = 0.4) +
  ylab('Rate per 100 000 population per year') + xlab('') +
  geom_line(aes(year, mort.h), colour = I('lightskyblue2')) +
  geom_ribbon(
    aes(year, ymin = mort.h.lo, ymax = mort.h.hi),
    fill = I('lightskyblue2'),
    alpha = 0.4
  ) +
  geom_line(aes(year, mort.nh), colour = I('blue')) +
  geom_ribbon(
    aes(year, ymin = mort.nh.lo, ymax = mort.nh.hi),
    fill = I('blue'),
    alpha = 0.4
  ) +
  geom_line(aes(year, mort), colour = I('grey20')) +
  geom_ribbon(aes(year, ymin = mort.lo, ymax = mort.hi),
              fill = I('grey40'),
              alpha = 0.4) +
#  expand_limits(y = 0.1) +
  annotate(
    'text',
    x = 2013,
    y = 28,
    label = 'Total',
    hjust = 0,
    size = I(4)
  ) +
  annotate(
    'text',
    x = 2013,
    y = 15,
    label = 'People without HIV people',
    hjust = 0,
    size = I(4)
  ) +
  annotate(
    'text',
    x = 2013,
    y = 5,
    label = 'People with HIV people',
    hjust = 0,
    size = I(4)
  ) +
 # scale_y_log10() +
  scale_x_continuous(breaks=c(2010,2015,2020)) +
  theme_gtb() + theme(legend.position = 'none')

output_ggplot(f1.2.1b_plot, global[, .(year, mort, mort.lo, mort.hi, mort.h, mort.h.lo, mort.h.hi, mort.nh, mort.nh.lo, mort.nh.hi)], show_static, pdf_csv_folder, save_csv, save_pdf)

```

<div class="col-md-6">
#### (a) Number
<div id="fig_1_2_1a"></div>
</div>
<div class="col-md-6">
#### (b) Rate per `r cm` population
<div id="fig_1_2_1b"></div>
</div>

<hr />
<br />


Global estimates of the number of deaths caused by TB have been revised downwards, compared with those published in 2022 (`r ref_lnk("2")`). The main explanation is that estimates for India have been revised downwards, based on recently published cause-of-death data from the country’s sample registration system (SRS) for 2014–2019. 

The increase in TB mortality estimated for 2021 is consistent with projections published in the *Global tuberculosis report 2021* (`r ref_lnk("2")`) and reflects the estimated impact of disruptions to essential TB services during the COVID-19 pandemic: in particular, drops in the number of people with TB who were detected and treated in 2020 and 2021 (<span class="red">Section 2</span>). The death rate for untreated TB is high (about 50%), and therefore the impact of reduced case detection on TB mortality is severe and noticeable within a short time period. The impact on TB incidence is more delayed (<span class="red">Section 1.1</span>). 

Disruptions during the COVID-19 pandemic and its aftermath are estimated to have resulted in close to half a million excess deaths from TB in the three years 2020–2022 (`r lnk("Fig. 1.2.2")`).

### `r anch("Fig. 1.2.2")`<span class="red">Fig. 1.2.2</span> Excess number of deaths caused by TB during the COVID-19 pandemic and its aftermath, 2020&#8211;2022

<div class="subhead"> The <span style="color:black">black</span> shaded area represents the 95% uncertainty interval of the actual number of deaths estimated to have been caused by TB; the <span style="color:red">red</span> line shows a counterfactual of the estimated number of deaths that would have been caused by TB in the absence of the COVID-19 pandemic; the <span style="color:red">red</span> shaded area shows the excess number of deaths caused by TB due to disruptions associated with the COVID-19 pandemic. </div> 

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=12, fig_1.2.2, fig.alt="Excess of mortality during COVID-19 disruption, 2020-2022"} 

```

<div id="fig_1_2_2"></div>

<hr />
<br />

In 2022, most of the estimated deaths caused by TB among HIV-negative people occurred in the WHO regions of South-East Asia (`r round(100*regional$mort.nh.num[regional$year==2022 & regional$g.whoregion=="SEA"]/global$mort.nh.num[global$year==2022],0)`%) and Africa (`r round(100*regional$mort.nh.num[regional$year==2022 & regional$g.whoregion=="AFR"]/global$mort.nh.num[global$year==2022],0)`%), with smaller shares in the Western Pacific (`r round(100*regional$mort.nh.num[regional$year==2022 & regional$g.whoregion=="WPR"]/global$mort.nh.num[global$year==2022],1)`%), the Eastern Mediterranean (`r round(100*regional$mort.nh.num[regional$year==2022 & regional$g.whoregion=="EMR"]/global$mort.nh.num[global$year==2022],1)`%), the Americas (`r round(100*regional$mort.nh.num[regional$year==2022 & regional$g.whoregion=="AMR"]/global$mort.nh.num[global$year==2022],1)`%) and Europe (`r round(100*regional$mort.nh.num[regional$year==2022 & regional$g.whoregion=="EUR"]/global$mort.nh.num[global$year==2022],1)`%); most of the TB deaths among people with HIV occurred in the African Region (68%) (`r lnk("Table 1.2.1")`).

### `r anch("Table 1.2.1")`<span class="red">Table 1.2.1</span> Global and regional estimates of TB mortality, numbers (in thousands) and rates (per `r cm` population) in 2022

<div class="subhead">Low and high are the 5th and 95th percentiles of the uncertainty interval (UI).</div>
```{r tab_1.2.1}

tab.header2 <- c('Region or country group','Best estimate','Low', 'High',
                  'Best estimate', 'Low', 'High',
                  'Best estimate', 'Low', 'High',
                  'Best estimate', 'Low', 'High'
                  )

knitr::kable(cbind(tab1[c(32:37, 31, 38), c(1, 9:14)], tab1b[c(32:37, 31, 38), 8:13]),
             format = "html",
             align = 'rcccccccccccc',
             col.names = tab.header2,
             # Add a table ID so that it can be styled using extra CSS in Sitefinity
             table.attr = "id='burden_num_table'") |>
add_header_above(header = c(" " = 1, "People without HIV" = 3, "People with HIV" = 3, "People without HIV" = 3, "People with HIV" = 3)) |>
add_header_above(header = c(" " = 1, "Number of deaths (in thousands)" = 6, "Rate per 100 000 population" = 6)) 
  # pack_rows("High burden countries", 1, 30) |>
  # pack_rows('Groupings', 31, 38) 

```

<hr />
<br />

Globally in 2022, `r round(100*sum(Mglobsplt$mort[Mglobsplt$sex=="M" & Mglobsplt$child==F]),0)`% of the HIV-negative people who died from TB were men, `r round(100*sum(Mglobsplt$mort[Mglobsplt$sex=="F" & Mglobsplt$child==F]),0)`% were women and `r round(100*sum(Mglobsplt$mort[Mglobsplt$child==T]),0)`% were children (aged <15 years) (`r lnk("Fig. 1.2.3")`). The higher share for children compared with their estimated share of cases (`r round(100*sum(globsplt$inc[globsplt$child==T])/global$inc.num[global$year==2022],0)`%) suggests poorer access to diagnosis and treatment. Of the TB deaths among people with HIV, `r round(MPglobsplit$deaths.pc[MPglobsplit$sex=="M" & MPglobsplit$acat=="15+"],0)`% were men, `r round(MPglobsplit$deaths.pc[MPglobsplit$sex=="F" & MPglobsplit$acat=="15+"],0)`% were women and `r round(sum(MPglobsplit$deaths.pc[MPglobsplit$acat=="0-14"]),0)`% were children. 

### `r anch("Fig. 1.2.3")` <span class="red">Fig. 1.2.3</span> Global distribution of estimated TB mortality in HIV-negative people and in people with HIV by age group and sex (female in <span style="color:#6363C0">purple</span>; male in <span style="color:#F4A81D">orange</span>), 2022 

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=6, fig_1.2.3, fig.alt="Main methods used to estimate TB mortality in People without HIV people"} 

 # source(here('disaggregation/reportoutput/plotfunctions.R'))
#  muplot <- function(indat,cnm){
#      agz2 <- c('0_4','5_14','15_24','25_34','35_44',
#                '45_54','55_64','65plus') #for labels
#      agz3 <- gsub('_','-',agz2)
#      agz4 <- c(rev(rev(agz3)[-1]),"\u226565")
#      if(!'age' %in% names(indat)) indat[,age:=gsub("_","-",age_group)]
#      indat[age=='65plus',age:=rev(agz4)[1]]
#      indat$age <- factor(indat$age,levels=agz4,ordered=TRUE)
#      indat$sex <- factor(indat$sex,levels=c('F','M'),ordered=TRUE)
#      ## plot
#      mp <- prodplot(data=indat,
#                     mort ~ sex + age,
#                     divider=mosaic()) +
#          aes(fill=sex)
#      mp <- mp + theme(axis.line=element_blank(),
#                       axis.text.x=element_text(angle=90),
#                       axis.text.y=element_text(),
#                       axis.ticks=element_blank(),
#                       axis.title.x=element_blank(),
#                       axis.title.y=element_blank(),
#                       legend.title=element_blank(),
#                       legend.position="none",
#                       panel.background=element_blank(),
#                       panel.border=element_blank(),
#                       panel.grid.major=element_blank(),
#                       panel.grid.minor=element_blank(),
#                       plot.background=element_blank()) +
#          ggtitle(cnm)
#      mp
#  }
#  
# mortsplit= disag.plot.mort.global <- function(D,title){
#      ## ages and colors etc
#      agz3 <- c('0\u20134','5\u201314','15\u201324','25\u201334','35\u201344','45\u201354',
#                '55-64','65plus') #for labels
#      agz4 <- c(rev(rev(agz3)[-1]),"\u226565")
#      clz <- c('F'=palette_gtb('female'),
#               'M'=palette_gtb('male'))
#      ## plot construction
#      plt <- muplot(D,title) +
#          coord_flip() +
#          scale_fill_manual(values=clz)+
#          theme_gtb()+
#          theme(axis.title.x=element_blank(), #remove
#                axis.text.x=element_blank(),
#                axis.ticks.x=element_blank(),
#                legend.position = 'none')
#      plt
#  }
#  
#  
#  annotate_figure(disag.plot.mort.global(Mglobsplt, 'Global'),
#                  left = text_grob('Age group (years)', rot = 90))

```

<div class="col-md-6">
#### (a) Among HIV-negative people
<div id="fig_1_2_3"></div>
</div>
<div class="col-md-6">
#### (b) Among people with HIV
<div id="fig_1_2_3b"></div>
</div>

<hr />
<br />

In 2022, an estimated total of `r thous(round(m.tot.male,-3)/1e3)` adult men (aged &#8805;15 years) died from TB (95% UI: `r thous(round(m.tot.male.lo,-3)/1e3)`–`r thous(round(m.tot.male.hi,-3)/1e3)`): `r thous(round(m.nh.male,-3)/1e3)` among those HIV-negative (95% UI: `r thous(round(m.nh.male.lo,-3)/1e3)`–`r thous(round(m.nh.male.hi,-3)/1e3)`) and `r thous(round(m.h.male,-3)/1e3)` among those with HIV (95% UI: `r thous(round(m.h.male.lo,-3)/1e3)`–`r thous(round(m.h.male.hi,-3)/1e3)`). An estimated total of `r thous(round(m.tot.fem,-3)/1e3)` adult women (aged &#8805;15 years) died from TB (95% UI: `r thous(round(m.tot.fem.lo,-3)/1e3)`–`r thous(round(m.tot.fem.hi,-3)/1e3)`): `r thous(round(m.nh.fem,-3)/1e3)` among those HIV-negative (95% UI: `r thous(round(m.nh.fem.lo,-3)/1e3)`–`r thous(round(m.nh.fem.hi,-3)/1e3)`) and `r thous(round(m.h.fem,-3)/1e3)` among those with HIV (95% UI: `r thous(round(m.h.fem.lo,-3)/1e3)`–`r thous(round(m.h.fem.hi,-3)/1e3)`).

In 2022, an estimated total of `r thous(round(m.tot.children,-3)/1e3)` children and young adolescents (<15 years) died from TB (95% UI: `r thous(round(m.tot.children.lo,-3)/1e3)`–`r thous(round(m.tot.children.hi,-3)/1e3)`): `r thous(round(m.nh.tot,-3)/1e3)` among those HIV-negative (95% UI: `r thous(round(m.nh.tot.lo,-3)/1e3)`–`r thous(round(m.nh.tot.hi,-3)/1e3)`) and `r thous(round(m.h.tot,-3)/1e3)` among those with HIV (95% UI: `r thous(round(m.h.tot.lo,-3)/1e3)`–`r thous(round(m.h.tot.hi,-3)/1e3)`). Among HIV-negative children and young adolescents, the estimated number of TB deaths in 2022 was `r thous(round(m.nh.l5,-3)/1e3)` among children aged <5 years (95% UI: `r thous(round(m.nh.l5.lo,-3)/1e3)`–`r thous(round(m.nh.l5.hi,-3)/1e3)`); and `r thous(round(m.nh.5.14,-3)/1e3)` in older children and young adolescents aged 5–14 years (95% UI: `r thous(round(m.nh.5.14.lo,-3)/1e3)`–`r thous(round(m.nh.5.14.hi,-3)/1e3)`).

The latest year for which WHO has published estimates of global deaths by cause remains 2019, when TB was the top cause of death from a single infectious agent and the 13th leading cause of death worldwide (`r lnk("Fig. 1.2.4")`). In 2022, it is anticipated that TB will rank second as a cause of death from a single infectious agent, after COVID-19  (`r ref_lnk("3")`).  

### `r anch("Fig. 1.2.4")`<span class="red">Fig. 1.2.4</span> Top causes of death worldwide in 2019 ^a,b^
<div class="subhead">Deaths from TB among people with HIV are shown in grey.</div>

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=6, fig_1.2.4, fig.alt="Top causes of death worldwide in 2019"} 

tbhiv <- global$mort.h.num[global$year == 2019] / 1e3
top10$tbhiv <- c(rep(0, 12), tbhiv, rep(0, 7))
top10$n <- top10$deaths / 1000 + top10$tbhiv / 1000

f1.2.4_plot <- ggplot(data = top10, aes(reorder(cause, deaths), n)) +
  geom_bar(stat = 'identity',
           fill = I('grey70'),
           colour = I('black')) +
  geom_bar(
    aes(cause, deaths / 1000),
    stat = 'identity',
    fill = I('#00aaad'),
    colour = I('black')
  ) +
  xlab('')  + ylab('Number of deaths (millions)') +
  scale_y_continuous(breaks = 0:9) +
  coord_flip() +
  theme_gtb()

output_ggplot(f1.2.4_plot, top10, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_1_2_4"></div>
<div class="footnote"> ^a^ This is the latest year for which estimates for all causes are currently available. See WHO estimates, available at https://www.who.int/data/gho/data/themes/mortality-and-global-health-estimates/ghe-leading-causes-of-death.<br>
^b^ Deaths from TB among people with HIV are officially classified as deaths caused by HIV/AIDS in the International Classification of Diseases. </div> 

<hr />
<br />

The estimated number of deaths officially classified as caused by TB (i.e. those among HIV-negative people) in 2022, at `r round(global$mort.nh.num[global$year==2022]/1e6,1)` million, was almost double the number of deaths caused by HIV/AIDS (0.63 million) (`r lnk("Fig. 1.2.5")`).  

### `r anch("Fig. 1.2.5")`<span class="red">Fig. 1.2.5</span> Estimated number of deaths caused by HIV/AIDS and TB in 2022 ^a,b^ 
<div class="subhead">Deaths from TB among people with HIV are shown in grey.</div>

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png',fig.height=6, fig_1.2.5, fig.alt="Estimated number of deaths from HIV/AIDS and TB in 2022"} 

hivd <- unaids[, .(sum(mort.hiv.num, na.rm = T)), by = year]
cod <- data.table(
  cause = c('HIV/AIDS', 'TB'),
  n = c((last(hivd$V1) - last(global$mort.h.num)) / 1e6, last(global$mort.nh.num) /
          1e6),
  tbhiv = rep(last(global$mort.h.num) / 1e6, 2)
)
cod[, total := n + tbhiv]

f1.2.5_plot <- ggplot(data = cod, aes(reorder(cause, total), total)) +
  geom_bar(stat = 'identity',
           fill = I('grey70'),
           colour = I('black')) +
  geom_bar(
    aes(cause, n),
    stat = 'identity',
    fill = I('#00aaad'),
    colour = I('black')
  ) +
  xlab('') + ylab('Millions (2022)') +
  coord_flip() +
  theme_gtb()

output_ggplot(f1.2.5_plot, cod, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_1_2_5"></div>
<div class="footnote"> ^a^ For HIV/AIDS, the latest estimates of the number of deaths in 2022 that have been published by UNAIDS are available at http://www.unaids.org/en/ (accessed 15 August 2023). For TB, the estimates for 2022 are those published in this report.<br>
^b^ Deaths from TB among people with HIV are officially classified as deaths caused by HIV/AIDS in the International Classification of Diseases.</div> 

<hr />
<br />

Compared with HIV, deaths from TB have been much more severely impacted by the COVID-19 pandemic (`r lnk("Fig. 1.2.6")`). In contrast to TB, deaths from HIV/AIDS continued to decline between 2019 and 2022 (`r ref_lnk("4")`). 

### `r anch("Fig. 1.2.6")`<span class="red">Fig. 1.2.6</span> Global trends in the estimated number of deaths caused by TB and HIV (in millions), 2000&#8211;2022 ^a,b^
<div class="subhead">Shaded areas represent 95% uncertainty intervals.</div> 

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig_1.2.6, fig.alt="Global trends in the estimated number of deaths caused by TB and HIV (in millions), 2000–2022"} 

m <- 1e5
ghiv.mort <-
  est[, addXY(mort.hiv / m, r.sd = mort.hiv.sd / m, weights = as.numeric(pop)), by =
        year]
dta <- merge(global, ghiv.mort, by = 'year')
M <- 1e6

f1.2.6_plot <- ggplot(data = subset(dta,year>=2010), aes(year, mort.h.num / M)) +
  geom_line(colour = I('lightskyblue2')) +
  geom_line(aes(year, mort.nh.num / M), colour = I('blue')) +
  geom_ribbon(
    aes(year, ymin = mort.h.lo.num / M, ymax = mort.h.hi.num / M),
    fill = I("lightskyblue2"),
    alpha = I(.4)
  ) +
  geom_ribbon(
    aes(year, ymin = mort.nh.lo.num / M, ymax = mort.nh.hi.num / M),
    fill = I("blue"),
    alpha = I(.4)
  ) +
  geom_line(aes(year, r.num / M), colour = I('grey50')) +
  geom_ribbon(
    aes(year, ymin = r.lo.num / M, ymax = r.hi.num / M),
    fill = I("grey50"),
    alpha = I(.4)
  ) +
  xlab('') + ylab('Millions of deaths per year') +
  annotate(
    'text',
    x = 2013,
    y = 0.8,
    label = 'HIV deaths',
    size = I(4),
    colour = I('grey50')
  ) +
  annotate(
    'text',
    x = 2013,
    y = 1.6,
    label = 'TB deaths in\nPeople without HIV people',
    size = I(4),
    colour = I('blue')
  ) +
  annotate(
    'text',
    x = 2013,
    y = 0.2,
    label = 'TB deaths in\nPeople with HIV people',
    size = I(4),
    colour = I('lightskyblue4')
  ) +
  expand_limits(y = c(0.2,1.8)) + 
  scale_y_continuous(breaks=seq(0.2,1.8,0.2)) +
  scale_x_continuous(breaks=c(2010,2015,2020)) +
    theme_gtb()


output_ggplot(f1.2.6_plot, dta[, .(year, mort.h.num, mort.h.lo.num, mort.h.hi.num, mort.nh.num, mort.nh.lo.num, mort.nh.hi.num, r.num, r.lo.num, r.hi.num)], show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_1_2_6"></div>
<div class="footnote"> ^a^ For HIV/AIDS, the latest estimates of the number of deaths in 2022 that have been published by UNAIDS are available at http://www.unaids.org/en/ (accessed 15 August 2023). For TB, the estimates for 2022 are those published in this report.<br>
^b^ Deaths from TB among people with HIV are officially classified as deaths caused by HIV/AIDS in the International Classification of Diseases.</div> 

<hr />
<br />

In 2022, the TB mortality rate fell in two WHO regions (the African and the Eastern Mediterranean regions) but increased in the Region of the Americas, and was relatively stable in the European, South–East Asia and Western Pacific regions (`r lnk("Fig. 1.2.7")`).

### `r anch("Fig. 1.2.7")`<span class="red">Fig. 1.2.7</span> Trends in estimated TB mortality rates by WHO region, 2010&#8211;2022
<div class="subhead">Estimated TB mortality rates among HIV-negative people are shown in <span style="color:#3232ff">blue</span> and estimated mortality rates among people with HIV are shown in <span style="color:#87ceeb">light blue</span>. Shaded areas represent 95% uncertainty intervals.</div> 

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height = 8, fig_1.2.7, fig.alt="Trends in estimated TB mortality rates by WHO region, 2010−2022"} 

f1.2.7_plot <- qplot(
    year,
    mort.nh,
    data = subset(regional,year>=2010),
    geom = 'line',
    colour = I('blue')
  ) +
  geom_ribbon(
    aes(year, ymin = mort.nh.lo, ymax = mort.nh.hi),
    fill = I('blue'),
    alpha = 0.4
  ) +
  geom_line(aes(year, mort.h), colour = I('lightskyblue2')) +
  geom_ribbon(
    aes(year, ymin = mort.h.lo, ymax = mort.h.hi),
    fill = I('lightskyblue2'),
    alpha = 0.4
  ) +
  expand_limits(y=0.1) +
  facet_wrap(~ region, scale = 'free_y') +
  xlab('') + ylab('Mortality rate per 100 000 population per year') +
  #  scale_y_continuous(trans='log10', breaks=c(0.1,1,5,10,20,30,50)) +
  theme_gtb() +
  #scale_y_log10() +
  scale_x_continuous(breaks=c(2010,2015,2020)) +
  theme(legend.position = 'none')

output_ggplot(f1.2.7_plot, regional[, .(region, year,  mort.nh,  mort.nh.lo,  mort.nh.hi, mort.h, mort.h.lo, mort.h.hi)], show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div class="row">
<div class="col-md-4">
<div id="fig_1_2_7_AFR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_7_AMR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_7_SEAR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_7_EUR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_7_EMR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_7_WPR"></div>
</div>
</div>

<hr />
<br />

Trends in the absolute number of TB deaths at regional level also vary (`r lnk("Fig. 1.2.8")`). The global pattern of a fall in the absolute number of deaths caused by TB (including those among people with HIV) until 2019, followed by increases in 2020–2021 and then a reversal in 2022, was also evident in the WHO Eastern Mediterranean and European regions. In the South–East Asia and Western Pacific regions, the estimated number of deaths caused by TB was stable in 2022 compared with 2021. In the Region of the Americas, the estimated number of deaths caused by TB continued to rise in 2022. In the African Region, the estimated number of deaths caused by TB fell up to 2019, was stable from 2019–2020 and then started to fall again.

### `r anch("Fig. 1.2.8")`<span class="red">Fig. 1.2.8</span> Trends in the estimated absolute number of TB deaths (HIV-negative people and people with HIV, in thousands) by WHO region, 2010&#8211;2022 
<div class="subhead">Shaded areas represent 95% uncertainty intervals. The horizontal dashed line shows the 2025 milestone of the End TB Strategy, which is a 75% reduction in the total number of deaths caused by TB between 2015 and 2025.</div> 
```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height = 8, fig_1.2.8, fig.alt="Trends in the estimated absolute number of TB deaths (People with HIV and People without HIV, in thousands) by WHO region, 2010-2022"} 

f1.2.8_plot <- qplot(
    year,
    mort.num / 1e3,
    data = subset(regional,year>=2010),
    geom = 'line',
    colour = I('black')
  ) +
  geom_ribbon(
    aes(year, ymin = mort.lo.num / 1e3, ymax = mort.hi.num / 1e3),
    fill = I('black'),
    alpha = 0.2
  ) +
  geom_hline(aes(yintercept = mort.milestone / 1e3), linetype = I(2)) +
#  expand_limits(y=0.1) +
  facet_wrap(~ region, scale = 'free_y') +
  xlab('') + ylab('Total TB deaths (thousands)') +
  #scale_y_log10() +
  theme_gtb() +
  theme(legend.position = 'none')


output_ggplot(f1.2.8_plot, regional[, .(region,year,mort.num,mort.lo.num,mort.hi.num,mort.milestone)], show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div class="row">
<div class="col-md-4">
<div id="fig_1_2_8_AFR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_8_AMR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_8_SEAR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_8_EUR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_8_EMR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_8_WPR"></div>
</div>
</div>

<hr />
<br />

The African Region and the European Region are the closest to reaching the 2025 milestone of the End TB Strategy, with reductions of `r round(100-100*regional$mort.num[regional$g.whoregion=="AFR" & regional$year==2022]/regional$mort.num[regional$g.whoregion=="AFR" & regional$year==2015],0)`% and `r round(100-100*regional$mort.num[regional$g.whoregion=="EUR" & regional$year==2022]/regional$mort.num[regional$g.whoregion=="EUR" & regional$year==2015],0)`% respectively between 2015 and 2022. The four other regions are still far from the 2025 milestone of the End TB Strategy, with progress up to 2019 set back by disruptions during the COVID-19 pandemic and its aftermath.

The regional distribution of TB deaths by age and sex in 2022 varies by WHO region (`r lnk("Fig. 1.2.9")`). 

### `r anch("Fig. 1.2.9")`<span class="red">Fig. 1.2.9</span> Regional distribution of estimated TB mortality in HIV-negative people by age group and sex (female in <span style="color:#6363C0">purple</span>; male in <span style="color:#F4A81D">orange</span>), 2022

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=10, fig_1.2.9, fig.alt="Main methods used to estimate TB mortality in people without HIV"} 
# 
# disag.plot.mort.regional <- function(D){
#     ## ages and colors etc
#     agz3 <- c('0\u20134','5\u201314','15\u201324','25\u201334','35\u201344','45\u201354',
#               '55-64','65plus') #for labels
#     agz4 <- c(rev(rev(agz3)[-1]),"\u226565")
#     # whozt <- c('Africa','The Americas','Eastern Mediterranean','Europe',
#     #            'South-East Asia',
#     #            'Western Pacific')
#     # regs <- c('AFR','AMR','EMR','EUR','SEA','WPR')
#     clz <- c('F'=palette_gtb('female'),
#              'M'=palette_gtb('male'))
#     wr <- levels(D$name)
#     ## plot construction
#     Pltlst <- list()
#     for(i in 1:6){
# #        plt <- muplot(D[g.whoregion==regs[i]],whozt[i]) +
#         plt <- muplot(D[name==wr[i]],wr[i]) +
#             theme(legend.position="none")
# #        if(!(i%%3==1)) plt <- plt + theme(axis.text.y=element_blank())
#         plt <- plt + coord_flip() +
#             scale_fill_manual(values=clz)+
#             theme_gtb()+
#             theme(axis.title.x=element_blank(),
#                   axis.text.x=element_blank(),
#                   axis.ticks.x=element_blank(),
#                   legend.position = 'none')
#         Pltlst[[i]] <- plt
#     }
#     p <- ggpubr::ggarrange(plotlist = Pltlst, ncol = 3,nrow=2)
#     annotate_figure(p, left = text_grob('Age group (years)', rot=90))
# }
# 
# disag.plot.mort.regional(Mregsplt)

```

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_9_AFR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_9_AMR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_9_SEAR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_9_EUR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_9_EMR"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_9_WPR"></div>
</div>
</div>

<hr />
<br />

Progress in reducing the total number of deaths caused by TB (among people with and without HIV) at country level is highly variable (`r lnk("Fig. 1.2.10")`). A total of 47 countries have reached or surpassed the first (2020) milestone of the End TB Strategy, which was a 35% reduction compared with a baseline of 2015. At the other extreme, the number of deaths caused by TB has increased in some countries, mainly related to disruptions caused by the COVID-19 pandemic. This is particularly true in the WHO Region of the Americas. 

### `r anch("Fig. 1.2.10")`<span class="red">Fig. 1.2.10</span> Change (%) in the estimated number of deaths caused by TB (among HIV-negative people and people with HIV), 2022 compared with 2015

<div class="subhead"> The last two categories (decrease 35&ndash;49%, and decrease &#8805;50%) distinguish the countries that have made the most progress towards the second milestone of the End TB strategy, which is a 75% reduction in the total number of deaths caused by TB between 2015 and 2025.</div>

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig_1.2.10, fig.alt="Change (%) in the estimated number of deaths caused by TB, 2022 compared with 2015"}


dta <- subset(est, year==yr, select=c("iso3","country","year","mort.num"))
dta2 <- subset(est, year==2015, select=c("iso3","year","mort.num"))
dta2$mort.num.2021=dta2$mort.num
dta2$mort.num=NULL

dta=merge(dta,dta2,by="iso3")
dta$rel.red.mort.num=(1-(dta$mort.num/dta$mort.num.2021))*100
dta$rel.red.mort.num.cat=ifelse(dta$rel.red.mort.num>0,"Reduction","Increase")

dta$rel.red.mort.num.fordisplay=ifelse(dta$rel.red.mort.num<0,
                                      -round(dta$rel.red.mort.num,1),
                                      round(dta$rel.red.mort.num,1))

dta$var <- cut(
  dta$rel.red.mort.num,
  c(-Inf,-5,5, 20, 35, 50,Inf),
  c('Increase (>5%)',"Stable (-5% to +5%)", 'Decrease (6\u201319%)', 'Decrease (20\u201334%)', 'Decrease (35\u201349%)','Decrease (\u226550%)'),
  right = F,
  ordered_result = T
)

f1.2.10_plot <- whomap(
  X = dta, water.col = 'white',
  legend.title = "Change (2022 vs 2015, %)",
  legend.pos = c(0.14, 0.34),
  colours = c("lightyellow2","lightyellow3",brewer.pal(4, "Blues"))
)

output_ggplot(f1.2.10_plot, dta, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />

Trends  in the total number of deaths caused by TB (among people with and without HIV) in the 30 high TB burden countries are also highly variable. Between 2019 and 2021, striking increases are estimated to have occurred in countries with major shortfalls in TB notifications in 2020 and 2021 (e.g. Indonesia, Myanmar, Philippines), while in others previous declines have slowed or stabilized. The countries estimated to have made the best progress between 2015 and 2022 are Kenya, Mozambique, Uganda, the United Republic of Tanzania and Zambia (`r lnk("Fig. 1.2.11")`).

### `r anch("Fig. 1.2.11")`<span class="red">Fig. 1.2.11</span> Trends in the estimated absolute number (in thousands) of deaths caused by TB (among HIV-negative people and people with HIV) in the 30 high TB burden countries, 2010&#8211;2022
<div class="subhead">Shaded areas represent 95% uncertainty intervals. The horizontal dashed line shows the 2025 milestone of the End TB Strategy, which is a 75% reduction in the total number of deaths caused by TB between 2015 and 2025.</div> 

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=12, fig_1.2.11, fig.alt="Trends in the estimated absolute number of TB deaths (People with HIV and People without HIV) in the 30 high TB burden countries, 2010−2022"} 

f1.2.11_plot <-  qplot(
    year,
    mort.num / 1e3,
    data = subset(hest,year>=2010),
    geom = 'line',
    colour = I('grey20')
  ) +
  geom_ribbon(
    aes(year, ymin = mort.lo.num / 1e3, ymax = mort.hi.num / 1e3),
    fill = I('black'),
    alpha = 0.2
  ) +
  geom_hline(aes(yintercept = mort.milestone / 1e3), linetype = I(2)) +
  #facet_wrap(~ country, scales = 'free_y', ncol = 5) +
    facet_wrap(~country, nrow=6, scales="free",
                     # Use the labeller function to make sure long country names are wrapped in panel headers
                     labeller = label_wrap_gen(width = 25)) +
  xlab('') + ylab('TB deaths (total, in thousands) per year') +
#  expand_limits(y = 0.1) +
  #scale_y_log10() +
  scale_x_continuous(breaks=c(2010,2015,2020)) +
  theme_gtb()

output_ggplot(f1.2.11_plot, hest[, .(country,year,mort.num,mort.lo.num,mort.hi.num,mort.milestone)], show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_AGO"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_BGD"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_BRA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_CAF"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_CHN"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_COG"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_PRK"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_COD"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_ETH"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_GAB"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_IND"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_IDN"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_KEN"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_LSO"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_LBR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_MNG"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_MOZ"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_MMR"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_NAM"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_NGA"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_PAK"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_PNG"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_PHL"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_SLE"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_ZAF"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_THA"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_UGA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_2_11_TZA"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_VNM"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_11_ZMB"></div>
</div>
</div>

<hr />
<br />

Of the three global TB watchlist countries, the Russian Federation is well on the way to reach the 2025 milestone (`r lnk("Fig. 1.2.12")`), with a cumulative reduction of `r round(100-100*est$mort.num[est$iso3=="RUS" & est$year=="2022"]/est$mort.num[est$iso3=="RUS" & est$year=="2015"],0)`% between 2015 and 2022. 

### `r anch("Fig. 1.2.12")`<span class="red">Fig. 1.2.12</span> Trends in the estimated absolute number (in thousands) of deaths caused by TB (among HIV-negative people and people with HIV) in the three global TB watchlist countries, 2010&#8211;2022
<div class="subhead">Shaded areas represent 95% uncertainty intervals. The horizontal dashed line shows the 2025 milestone of the End TB Strategy, which is a 75% reduction in the total number of deaths caused by TB between 2015 and 2025.</div> 
```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=2.7, fig.width=8, fig.align='left', fig_1.2.12, fig.alt="Trends in the estimated absolute number of TB deaths (People with HIV and People without HIV TB) in the 3 WHO watch-list countries, 2010−2022"} 

dta <- est[iso3 %in% c('KHM','RUS','ZWE')]
dta[, mort.milestone := mort.num[16] * 0.25, by = iso3]

f1.2.12_plot <- qplot(
    year,
    mort.num / 1e3,
    data = subset(dta,year>=2010),
    geom = 'line',
    colour = I('grey20')
  ) +
  geom_ribbon(
    aes(year, ymin = mort.lo.num / 1e3, ymax = mort.hi.num / 1e3),
    fill = I('blue'),
    alpha = 0.4
  ) +
  geom_hline(aes(yintercept = mort.milestone / 1e3), linetype = I(2)) +
  #facet_wrap(~ country, scales = 'free_y', ncol = 5) +
    facet_wrap(~country, nrow=1, scales="free",
                     # Use the labeller function to make sure long country names are wrapped in panel headers
                     labeller = label_wrap_gen(width = 25)) +
  xlab('') + ylab('TB deaths (total, in thousands)\nper year') +
  scale_x_continuous(breaks=c(2010,2015,2020)) +
#  expand_limits(y = 0.1) +
  #scale_y_log10() +
  theme_gtb()

output_ggplot(f1.2.12_plot, dta[, .(country,year,mort.num,mort.lo.num,mort.hi.num,mort.milestone)], show_static, pdf_csv_folder, save_csv, save_pdf)


```
<div class="row">
<div class="col-md-4">
<div id="fig_1_2_12_KHM"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_12_RUS"></div>
</div>
<div class="col-md-4">
<div id="fig_1_2_12_ZWE"></div>
</div>
</div>

<hr />
<br />

There is considerable national variation in the TB mortality rate; in 2022, most of the countries with the highest rates were in the African Region (`r lnk("Fig. 1.2.13")`). 

### `r anch("Fig. 1.2.13")`<span class="red">Fig. 1.2.13</span> Estimated TB mortality rates in HIV-negative people, 2022

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig_1.2.13, fig.alt="Estimated TB mortality rates in HIV-negative people, 2022"} 

dta <- est[year == yr]
dta$var <- cut(
  dta$mort.nh,
  c(0, 1, 5, 20, 40, Inf),
  c('0\u20130.9', '1\u20134.9', '5\u201319', '20\u201339', '\u226540'),
  right = F,
  ordered_result = T
)

f1.2.13_plot <- whomap(
  X = dta, water.col = 'white',
  legend.title = "Mortality\nper 100 000\npopulation per year",
  legend.pos = c(0.14, 0.34),
  colours = brewer.pal(5, "RdPu"),
)

output_ggplot(f1.2.13_plot, dta[, .(country, mort.nh, var)], show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />

There is also considerable variation in the case fatality ratio (CFR) i.e. the estimated proportion of people who develop TB that die from the disease (`r lnk("Fig. 1.2.14")`). Globally, the CFR was `r round(100*global$cfr[global$year==2022],1)`% in 2022, down from `r round(100*global$cfr[global$year==2021],1)`% in 2021 and lower than the `r round(100*global$cfr[global$year==2019],1)`% estimated for 2019. 

### `r anch("Fig. 1.2.14")`<span class="red">Fig. 1.2.14</span> Estimates of the case fatality ratio (CFR), including HIV-negative people and people with HIV, 2022

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig_1.2.14, fig.alt="Case fatality ratio (2022)"} 

dta <-
  est[year == yr & inc > 0, .(iso3,
                        cfr = 100 * mort / inc)]
dta$var <- cut(dta$cfr, 
               breaks=c(0, 5, 10, 15, 20, Inf),
               labels=c('0\u20134.9','5\u20139.9','10\u201314','15\u201319','\u226520'))

f1.2.14_plot <- whomap(
  X = dta, water.col = 'white',
  colours = brewer.pal(5, "YlOrRd"),
  legend.title = 'Case fatality ratio\n(%)',
)

output_ggplot(f1.2.14_plot, dta, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

`r anch("Box 1.2.1")`

<div class="textbox">
## Box 1.2.1 

## Methods used by WHO to estimate TB mortality 

The main methods used by WHO to estimate TB mortality at country level in the periods 2010–2019 and 2020–2022 are shown in  (`r lnk("Fig. 1.2.15")`) and (`r lnk("Fig. 1.2.16")`). These methods adhere to global guidelines for accurate and transparent reporting of health estimates (`r ref_lnk("5")`) and are described in detail in a <span class="red">technical appendix</span>.

For 124 countries, estimates of the number of deaths caused by TB among HIV-negative people for the period 2010-2019 are based on data on causes of death from national vital registration (VR) systems or mortality surveys (`r lnk("Fig. 1.2.15")`), which collectively accounted for 60% of the estimated global number of deaths caused by TB (among HIV-negative people) in 2019. For 20 of these countries, analyses of VR data and resulting estimates of TB deaths published by the Institute of Health Metrics and Evaluation (IHME) were used (`r ref_lnk("6")`). For all other countries, TB mortality among HIV-negative people was estimated indirectly as the product of TB incidence and case fatality ratio (CFR), with the CFR derived from a literature review and adjusted to account for TB treatment (treated or untreated). For all countries, TB mortality among people with HIV was estimated as the product of TB incidence and the CFR, with the latter accounting for TB treatment (started or not started), antiretroviral treatment (ART, started or not started) and the duration of ART.

To produce estimates of TB disease burden in the period 2020–2022, country-specific dynamic models were developed for the 26 countries with the biggest absolute reductions in TB notifications during the COVID-19 pandemic (when these reductions departed from pre-2020 trends). However, for four of these countries, data on the number of deaths caused by TB that were recorded in national VR systems and reported to the WHO Global Tuberculosis Programme as part of the annual process of reviewing draft TB country profiles were used instead of model-based estimates (`r lnk("Fig. 1.2.16")`). For other low and middle-income countries, region-specific dynamic models or the indirect method described above (i.e. the product of estimates of TB incidence and the CFR) were used. Estimates for high-income countries were based on the same methods as those used up to 2019 i.e. data from national VR systems, with the assumption that the pre-2020 trend was sustained. 

Estimates of the annual number of deaths caused by TB in India have been revised downwards, compared with previous estimates published by WHO. This follows the availability of new cause-of-death data from the country’s sample registration system (SRS) for the period 2014–2019. For more details, see <span class="red">Box 4</span> of the *Global tuberculosis report 2023*.

### `r anch("Fig. 1.2.15")`<span class="red">Fig. 1.2.15</span> Main methods used to estimate TB mortality in HIV-negative people, 2010&#8211;2019

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig_1.2.15, fig.alt="Main methods used to estimate TB mortality in people without HIV, 2010-2019"} 

dta <-
  est[year == 2019, .(iso3,
                        source.mort)]
dta$var <- dta$source.mort

dta$var <- plyr::revalue(dta$var, c("IHME"="IHME estimates", "Indirect"="Indirect estimates", "VR data"="VR data based estimates", "VR data and pre-2020 trend"="VR data based estimates"))


f1.2.15_plot <- whomap(
  X = dta, water.col = 'white',
  legend.title = 'Main method',
  #colours = brewer.pal(3, "RdYlBu")
  colours= c("#74c476", "#ffffcc", "#2c7fb8"),
  legend.pos = c(0.11, 0.26)
)

output_ggplot(f1.2.15_plot, dta, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```
<div class="footnote"> IHME: Institute of Health Metrics and Evaluation, Seattle, USA. VR: Vital registration of causes of deaths.</div> 

<hr />
<br />

### `r anch("Fig. 1.2.16")`<span class="red">Fig. 1.2.16</span> Main methods used to estimate TB mortality in HIV-negative people, 2020&#8211;2022

```{r echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig_1.2.16, fig.alt="Main methods used to estimate TB mortality in people without HIV, 2020-2022"} 

dta <-
  est[year == yr, .(iso3,
                    source.mort)]
dta['CHN', source.mort := 'VR']
dta['RUS', source.mort := 'VR']
dta$var <- factor(dta$source.mort)

dta$var <- plyr::revalue(dta$var, c("Country model"="Country-specific dynamic model", "Regional model"="Region-specific dynamic model", "VR"="VR data for 2020-2022", "VR/IHME, extrapolated"="VR data and pre-2020 trend","Pre-2020 trends"="VR data and pre-2020 trend"))


f1.2.16_plot <- whomap(
  X = dta, water.col = 'white',
  legend.title = 'Main method',
  #colours = brewer.pal(5, "Dark2"),
  colours= c("#88be3b", "#ffffcc","#308047", "#41b6c4", "#2c7fb8"),
  legend.pos = c(0.11, 0.26)
)

output_ggplot(f1.2.16_plot, dta, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```
<div class="footnote"> VR: Vital registration of causes of deaths.</div> 

</div>



Country-specific details are available in the [Global tuberculosis report app](https://www.who.int/teams/global-tuberculosis-programme/data#app) and [country profiles](https://worldhealthorg.shinyapps.io/tb_profiles/).

Note : All of the percentage reductions or increases referred to in the text of this webpage were calculated based on unrounded numbers, as opposed to the rounded numbers that appear in the interactive graphics.

`r anch("refs")`

<hr style="border:1px solid gray20">

**References**


1. International statistical classification of diseases and health related problems (The) ICD-10. Geneva: World Health Organization; 2016 (https://icd.who.int/browse10/2016/en). 

2. Global tuberculosis report 2022. Geneva: World Health Organization; 2022 (https://iris.who.int/handle/10665/363752). 

3. Coronavirus (COVID-19) dashboard. Geneva: World Health Organization. (https://covid19.who.int/).

4. AIDS info [website]. 2023 (http://aidsinfo.unaids.org/). 

5. Guidelines for Accurate and Transparent Health Estimates Reporting (GATHER) [website]. Geneva: World Health Organization; 2021 (http://gather-statement.org/). 

6. GBD results tool [website]. Global Health Data Exchange; 2020 (http://ghdx.healthdata.org/gbd-results-tool). 





```{r js_functions}
# Insert javascript file containing common Kendo number formatting functions ----
cat(writeLines(readLines(here("report/resources/gtbr_js.htm"))))
```


```{r, json_2_1} 
# renaming variable for Kendo UI
names(global) <- gsub('[.]', '_', names(global))

names(regional) <- gsub('[.]', '_', names(regional))

names(hest) <- gsub('[.]', '_', names(hest))

names(excessmort) <- gsub('[.]', '_', names(excessmort))


# fig 1.2.4
tbhiv <- global$mort_h_num[global$year == 2019] / 1e3
top10$tbhiv <- c(rep(0, 12), tbhiv, rep(0, 7))
top10$n <- top10$deaths / 1000 + top10$tbhiv / 1000

# fig 1.2.5
names(unaids) <- gsub('[.]', '_', names(unaids))
hivd <- unaids[, .(sum(mort_hiv_num, na.rm = T)), by = year]
cod <- data.table(
  cause = c('HIV/AIDS', 'TB'),
  n = c((last(hivd$V1) - last(global$mort_h_num)) , last(global$mort_nh_num) ),
  tbhiv = rep(last(global$mort_h_num) , 2)
)
cod[, total := n + tbhiv]

# fig 1.2.6
m <- 1e5
ghiv.mort <-
  est[, addXY(mort.hiv / m, r.sd = mort.hiv.sd / m, weights = as.numeric(pop)), by =
        year]
dta_1_2_6 <- merge(global, ghiv.mort, by = 'year')
names(dta_1_2_6) <- gsub('[.]', '_', names(dta_1_2_6))

# fig 1.2.12
dta_1_2_12 <- est[iso3 %in% c('KHM','RUS','ZWE')]
dta_1_2_12[, mort.milestone := mort.num[16] * 0.25, by = iso3]
names(dta_1_2_12) <- gsub('[.]', '_', names(dta_1_2_12))

```


<script type="text/javascript">

/* JSON data objects for the figures */

var fig_1_2_1a_data = `r subset(global,year>=2010) %>% select(year,mort_num,mort_lo_num,mort_hi_num,mort_h_num,mort_h_hi_num,mort_h_lo_num,mort_nh_num,mort_nh_hi_num,mort_nh_lo_num) %>% mutate(milestone = as.numeric(select(filter(global,year==2015),mort_num))*0.25) %>% toJSON("rows")`; 
var fig_1_2_1b_data = `r subset(global,year>=2010) %>% select(year,mort,mort_lo,mort_hi,mort_h,mort_h_hi,mort_h_lo,mort_nh,mort_nh_hi,mort_nh_lo)  %>% toJSON("rows")`; 

var fig_1_2_2_data = `r subset(excessmort,year>=2010) %>% toJSON("rows")`; 

var fig_1_2_3_data = `r mort.split %>%  mutate(age = str_replace(age, "-", "\u2013")) %>% toJSON("rows")`; 

var fig_1_2_3b_data = `r mort.split.h %>% toJSON("rows")`; 



var fig_1_2_4_data = `r top10  %>% select(cause,deaths,tbhiv) %>% toJSON("rows")`; 

var fig_1_2_5_data = `r cod %>% arrange(desc(n)) %>% toJSON("rows")`; 

var fig_1_2_6_data = `r subset(dta_1_2_6,year>=2000) %>% select(year,mort_h_num,mort_h_hi_num,mort_h_lo_num,mort_nh_num,mort_nh_hi_num,mort_nh_lo_num,r_num,r_lo_num,r_hi_num) %>% toJSON("rows")`; 

var fig_1_2_7_data = `r subset(regional,year>=2010) %>% select(region,year,mort_h,mort_h_hi,mort_h_lo,mort_nh,mort_nh_hi,mort_nh_lo)  %>% toJSON("rows")`; 

var fig_1_2_8_data = `r subset(regional,year>=2010) %>% select(entity = region,year,mort_num,mort_hi_num,mort_lo_num,mort_milestone)  %>% toJSON("rows")`; 

var fig_1_2_11_data = `r subset(hest,year>=2010) %>% select(entity = country,year,mort_num,mort_hi_num,mort_lo_num,mort_milestone)  %>% toJSON("rows")`; 

var fig_1_2_9_data_afr= `r mort.split.reg.afr %>% mutate(age = str_replace(age, "-", "\u2013")) %>% toJSON("rows")`;
var fig_1_2_9_data_amr= `r mort.split.reg.amr %>% mutate(age = str_replace(age, "-", "\u2013")) %>% toJSON("rows")`;
var fig_1_2_9_data_emr= `r mort.split.reg.emr %>% mutate(age = str_replace(age, "-", "\u2013")) %>% toJSON("rows")`;
var fig_1_2_9_data_eur= `r mort.split.reg.eur %>% mutate(age = str_replace(age, "-", "\u2013")) %>% toJSON("rows")`;
var fig_1_2_9_data_sea= `r mort.split.reg.sea %>% mutate(age = str_replace(age, "-", "\u2013")) %>% toJSON("rows")`;
var fig_1_2_9_data_wpr= `r mort.split.reg.wpr %>% mutate(age = str_replace(age, "-", "\u2013")) %>% toJSON("rows")`;

var fig_1_2_12_data = `r subset(dta_1_2_12,year>=2010) %>% select(entity = country,year,mort_num,mort_hi_num,mort_lo_num,mort_milestone)  %>% toJSON("rows")`; 

</script>


```{js, echo=FALSE}

function mort_num_spacer(number) {
  /* Change thousands separator to a non-breaking space as per WHO standard */
  if (number>=1) {
    return kendo.toString(number, 'n2').replace(/,/g, '&nbsp;');
  } else {
    return kendo.toString(number, 'n3').replace(/,/g, '&nbsp;');
  }

}

function mort_rate_spacer(number) {
  /* Change thousands separator to a non-breaking space as per WHO standard */
  if (number>=1) {
    return kendo.toString(number, 'n1').replace(/,/g, '&nbsp;');
  } else {
    return kendo.toString(number, 'n2').replace(/,/g, '&nbsp;');
  }

}

function tb_format_thou_2(n) { 
  nt = n/1000; 
  if (nt < 100) {
    ntform = Number(nt.toPrecision(2))*1000;
      } else {
    ntform = Number(nt.toPrecision(3))*1000;
  } 
  return num_spacer(ntform)
}

/* Functions to create the figures */

function createFig_1_2_1a(fig_ID) {
 
		$(fig_ID).kendoChart({
			dataSource: fig_1_2_1a_data,
			chartArea: {
				height: 500
			},	
			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
        name: "Total number of TB deaths",
				field: "mort_num",
				color: "black",
				tooltip: {
					visible: true,
					template: "Total number of TB deaths (#= category #): #= mort_num_spacer((value/1e6)) # million"
				}
			},{
				type: "rangeArea",
				fromField: "mort_lo_num",
				toField: "mort_hi_num",
				color: "black",
				tooltip: {
					visible: true,
  				template: "95% uncertainty interval (#= category #): #= mort_num_spacer((value.from/1e6)) #\u2013#= mort_num_spacer((value.to/1e6)) # million"
				}
			},{
				type: "line",
        name: "TB deaths in people without HIV",
				field: "mort_nh_num",
				color: "blue",
				tooltip: {
					visible: true,
					template: "TB deaths in people without HIV (#= category #): #= mort_num_spacer((value/1e6)) # million"
				}
			},{
				type: "rangeArea",
				fromField: "mort_nh_lo_num",
				toField: "mort_nh_hi_num",
				color: "blue",
				tooltip: {
					visible: true,
  				template: "95% uncertainty interval (#= category #): #= mort_num_spacer((value.from/1e6)) #\u2013#= mort_num_spacer((value.to/1e6)) # million"
				}
			},{
				type: "line",
        name: "TB deaths in people with HIV",
				field: "mort_h_num",
				color: "lightskyblue",
				tooltip: {
					visible: true,
					template: "TB deaths in people with HIV (#= category #): #= mort_num_spacer((value/1e6)) # million"
				}
			},{
				type: "rangeArea",
				fromField: "mort_h_lo_num",
				toField: "mort_h_hi_num",
				color: "lightskyblue",
				tooltip: {
					visible: true,
  				template: "95% uncertainty interval (#= category #): #= mort_num_spacer((value.from/1e6)) #\u2013#= mort_num_spacer((value.to/1e6))  # million"
				}
			},{
        type: "line",
        dashType: "dash",
        field: "milestone",
        color: "grey",
        markers: {
             size: 0,
             opacity: 0
           },
			tooltip: {
				visible: false
			}
      },],      
            render: function (e) {
            var draw = kendo.drawing;
            var padding = 100;
            var padding2 = 350;
            var element = this.element;
            var rect = new kendo.geometry.Rect([padding, padding2], [element.width() - 2 * padding, element.height() - 2 * padding2]);

            var text = new draw.Text("2025 milestone", [0, 0], { font: "bold 9px Verdana,Arial,sans-serif" });
            draw.align([text], rect, "start");
            draw.vAlign([text], rect, "start");
            e.sender.surface.draw(text);
          },
			valueAxis: {
        labels: {
					template: "#= axis_spacer(value/1e6) #"
				},
				title: {
					text: "Millions per year",
					visible: true
				},
        min: 0,
				line: {
					visible: false
				}
			},
			categoryAxis: {
			  max: 2022,
				field: "year",
				labels: {
					rotation: "auto",
          step: 2
				},
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: true
				}
			}

		});
}



function createFig_1_2_1b(fig_ID) {
 
		$(fig_ID).kendoChart({
			dataSource: fig_1_2_1b_data,
			chartArea: {
				height: 500
			},	
			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
        name: "Total TB deaths",
				field: "mort",
				color: "black",
				tooltip: {
					visible: true,
					template: "Total TB deaths (#= category #): #= mort_rate_spacer(value) # per 100&nbsp;000 population"
				}
			},{
				type: "rangeArea",
				fromField: "mort_lo",
				toField: "mort_hi",
				color: "black",
				tooltip: {
					visible: true,
  				template: "95% uncertainty interval (#= category #): #= mort_rate_spacer(value.from) #–#= mort_rate_spacer(value.to) # per 100&nbsp;000 population"
				}
			},{
				type: "line",
        name: "TB deaths in people without HIV",
				field: "mort_nh",
				color: "blue",
				tooltip: {
					visible: true,
					template: "TB deaths in people without HIV (#= category #): #= mort_rate_spacer(value) # per 100&nbsp;000 population"
				}
			},{
				type: "rangeArea",
				fromField: "mort_nh_lo",
				toField: "mort_nh_hi",
				color: "blue",
				tooltip: {
					visible: true,
				  template: "95% uncertainty interval (#= category #): #= mort_rate_spacer(value.from) #–#= mort_rate_spacer(value.to) # per 100&nbsp;000 population"
				}
			},{
				type: "line",
        name: "TB deaths in people with HIV",
				field: "mort_h",
				color: "lightskyblue",
				tooltip: {
					visible: true,
					template: "TB deaths in people with HIV (#= category #): #= mort_rate_spacer(value) # per 100&nbsp;000 population"
				}
			},{
				type: "rangeArea",
				fromField: "mort_h_lo",
				toField: "mort_h_hi",
				color: "lightskyblue",
				tooltip: {
					visible: true,
				  template: "95% uncertainty interval (#= category #): #= mort_rate_spacer(value.from)  #–#= mort_rate_spacer(value.to)  # per 100&nbsp;000 population"
				}
			},],      

			valueAxis: {
        labels: {
					template: "#= axis_spacer(value) #"
				},
				title: {
					text: "Rate per 100 000 population per year",
					visible: true
				},
        min: 0,
				line: {
					visible: false
				}
			},
			categoryAxis: {
				field: "year",
				labels: {
					rotation: "auto",
          step: 2
				},
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: true
				}
			}

		});
}




function createFig_1_2_2(fig_ID) {

		$(fig_ID).kendoChart({
			dataSource: fig_1_2_2_data,
			chartArea: {
				height: 500
			},	
			legend: {
				position: "bottom",
				  orientation: "vertical",

			},
      series: [{
				type: "line",
        name: "Total number of TB deaths\n(in the absence of the COVID-19 pandemic)",
				field: "mort_cf_num",
				color: "red",
				tooltip: {
					visible: true,
					template: "Total number of TB deaths under the counterfactual (#= category #): #= mort_num_spacer((value/1e6)) # million"
				}
			},{
				type: "line",
        name: "Total number of TB deaths\n(estimated to have been caused by TB)",
				field: "mort_num",
				color: "black",
				tooltip: {
					visible: true,
					template: "Total number of TB deaths (#= category #): #= mort_num_spacer((value/1e6)) # million"
				}
			},{
				type: "rangeArea",
				fromField: "mort_lo_num",
				toField: "mort_hi_num",
				color: "black",
				tooltip: {
					visible: true,
  				template: "95% uncertainty interval (#= category #): #= mort_num_spacer((value.from/1e6)) #\u2013#= mort_num_spacer((value.to/1e6)) # million"
				}
			},{
				type: "rangeArea",
				fromField: "mort_cf_num",
				toField: "mort_num",
				color: "red"
			},],    
			valueAxis: {
        labels: {
					template: "#= axis_spacer(value/1e6) #"
				},
				title: {
					text: "Millions per year",
					visible: true
				},
        min: 0,
				line: {
					visible: false
				}
			},
			categoryAxis: {
			  max: 2022,
				field: "year",
				labels: {
					rotation: "auto",
          step: 2
				},
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: true
				}
			}

		});
}


function createFig_1_2_3(fig_ID, data, category_field, min) {
  
		$(fig_ID).kendoChart({		
      dataSource: data,			
      chartArea: {
				height: 400
			},	  
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "bar",
        stack: true,
        gap: 0.2
			},
			series: [{
				field: "M",
				color: "#F4A81D",
        tooltip: {
				visible: true,
				template: "Estimated number of deaths in males aged #= category # years: #= tb_format_thou_2(dataItem.M)#"
			}
			},{
				field: "F",
				color: "#6363C0",
        tooltip: {
				visible: true,
				template: "Estimated number of deaths in females aged #= category # years: #= tb_format_thou_2(dataItem.F*(-1))#"
			}
			},
              ],
			valueAxis: {
				labels: {
				template:  "#= kendo.toString(Math.abs(value),'n0').replace(/,/g, ' ') #",
				},
        title: {
					text: "Number of deaths"
				},
				line: {
					visible: false
				},
        axisCrossingValue: min,
        min: min
			},
			categoryAxis: {
				field: category_field,
				labels: {
					rotation: "auto"
				},
        title: {
					text: "Age group (years)"
				},
				majorGridLines: {
					visible: false
				}			}
		});
}


function createFig_1_2_4(fig_ID) {
		$(fig_ID).kendoChart({
			dataSource: fig_1_2_4_data,
			chartArea: {
				height: 600
			},	
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "bar",
        stack: true
			},
			series: [{
				field: "deaths",
				color: "#00aaad",
        gap: 0.2,
        tooltip: {
				visible: true,
				template: "#= category #: #= Number((value/1e3).toPrecision(2)) # million"
			}
			},{
				field: "tbhiv",
				color: "grey",
        tooltip: {
				visible: true,
				template: "#= category #, TB-HIV: #= Number((value/1e3).toPrecision(2)) # million"
			}
			},],
			valueAxis: {
				labels: {
					template: "#= axis_spacer(value/1e3) #",
					step: 2
				},
				title: {
					text: "Number of deaths\n(millions)"
				},
				line: {
					visible: false
				}
			},
			categoryAxis: {
				field: "cause",
				labels: {
					rotation: "auto"
				},
				majorGridLines: {
					visible: false
				}
			},

		});
}



function createFig_1_2_5(fig_ID) {
		$(fig_ID).kendoChart({
			dataSource: fig_1_2_5_data,
			chartArea: {
				height: 300
			},	
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "bar",
        stack: true
			},
			series: [{
				field: "n",
				color: "#00aaad",
        gap: 0.2,
        tooltip: {
				visible: true,
				template: "#= category #: #= Number((value/1e6).toPrecision(2)) # million"
			}
			},{
				field: "tbhiv",
				color: "grey",
        tooltip: {
				visible: true,
				template: "TB-HIV: #= Number((value/1e6).toPrecision(2)) # million"
			}
			},],
			valueAxis: {
				labels: {
					template: "#= num_spacer(value/1e6) #"
				},
				title: {
					text: "Number of deaths (millions)"
				},
				line: {
					visible: false
				}
			},
			categoryAxis: {
				field: "cause",
				labels: {
					rotation: "auto"
				},
				majorGridLines: {
					visible: false
				}
			},

		});
}

function createFig_1_2_6(fig_ID) {
 
		$(fig_ID).kendoChart({
			dataSource: fig_1_2_6_data,
			chartArea: {
				height: 500
			},	
			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
        name: "TB deaths in people without HIV",
				field: "mort_nh_num",
				color: "blue",
				tooltip: {
					visible: true,
					template: "TB deaths in people without HIV (#= category #): #= mort_num_spacer((value/1e6)) # million"
				}
			},{
				type: "rangeArea",
				fromField: "mort_nh_lo_num",
				toField: "mort_nh_hi_num",
				color: "blue",
				tooltip: {
					visible: true,
				format: "{0}",
				template: "95% uncertainty interval (#= category #): #= mort_num_spacer((value.from/1e6)) #–#= mort_num_spacer((value.to/1e6)) # million"
				}
			},{
				type: "line",
        name: "HIV deaths",
				field: "r_num",
				color: "black",
				tooltip: {
					visible: true,
					template: "HIV deaths (#= category #): #= mort_num_spacer((value/1e6)) # million"
				}
			},{
				type: "rangeArea",
				fromField: "r_lo_num",
				toField: "r_hi_num",
				color: "black",
				tooltip: {
					visible: true,
				format: "{0}",
				template: "95% uncertainty interval (#= category #): #= mort_num_spacer((value.from/1e6))#–#= mort_num_spacer((value.to/1e6)) # million"
				}
			},{
				type: "line",
        name: "TB deaths in people with HIV",
				field: "mort_h_num",
				color: "lightskyblue",
				tooltip: {
					visible: true,
					template: "TB deaths in people with HIV (#= category #): #= mort_num_spacer((value/1e6)) # million"
				}
			},{
				type: "rangeArea",
				fromField: "mort_h_lo_num",
				toField: "mort_h_hi_num",
				color: "lightskyblue",
				tooltip: {
					visible: true,
				format: "{0}",
				template: "95% uncertainty interval (#= category #): #= mort_num_spacer((value.from/1e6))  #–#= mort_num_spacer((value.to/1e6))  # million"
				}
			},],      

			valueAxis: {
        labels: {
					template: "#= axis_spacer(value/1e6) #"
				},
				title: {
					text: "Millions of deaths per year",
					visible: true
				},
        min: 0,
				line: {
					visible: false
				}
			},
			categoryAxis: {
				field: "year",
				labels: {
					rotation: 0,
          step: 5
				},
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year",
					visible: true
				}
			}

		});
}


function createFig_1_2_7(fig_ID, data, filter, min, unit) {
 
  	// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.region == filter);
  
		$(fig_ID).kendoChart({		
      dataSource: dataJSON,			
			chartArea: {
				height: 400
			},	      
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif",
        align: "center"
			},	  

			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
				field: "mort_nh",
				color: "blue",
        markers: { size: 4},
				tooltip: {
					visible: true,
					template: "TB mortality rate among people without HIV (#= category #): #= num_spacer(value) # per 100&nbsp;000 population"
				}
			},{
				type: "rangeArea",
				fromField: "mort_nh_lo",
				toField: "mort_nh_hi",
				color: "blue",
				tooltip: {
					visible: true,
				format: "{0}",
				template: "95% uncertainty interval (#= category #): #= num_spacer(value.from) #–#= num_spacer(value.to) # per 100&nbsp;000 population"
				}
			},{
				type: "line",
				field: "mort_h",
				color: "lightskyblue", 
        markers: { size: 4},
				tooltip: {
					visible: true,
					template: "TB mortality rate among people with HIV (#= category #): #= num_spacer(value) # per 100&nbsp;000 population"
				}
			},{
				type: "rangeArea",
				fromField: "mort_h_lo",
				toField: "mort_h_hi",
				color: "lightskyblue",
				tooltip: {
					visible: true,
				format: "{0}",
				template: "95% uncertainty interval (#= category #): #= num_spacer(value.from) #–#= num_spacer(value.to) # per 100&nbsp;000 population"
				}
			},],      
      
			valueAxis: {
        labels: {
					template: "#= axis_spacer(value) #"
				},
				title: {
					text: "Mortality rate per 100 000 population per year",
					visible: true
				},
       min: 0,
        axisCrossingValue: 0.1,
				line: {
					visible: false
				}
			},      

			categoryAxis: {
				field: "year",
				labels: {
					rotation: 0,
          step: 2
				},
				majorGridLines: {
					visible: false
				},

				title: {
					text: "Year",
					visible: true
				}
			}

		});
}
 
function createFig_1_2_81112(fig_ID, data, filter, fig_height, min, unit) {
 
  	// Filter the dataset on the entity variable
		dataJSON = data.filter( element => element.entity == filter);
  
		$(fig_ID).kendoChart({		
      dataSource: dataJSON,			
			chartArea: {
				height: fig_height
			},	      
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif",
        align: "center"
			},	  

			legend: {
				position: "bottom"
			},
      series: [{
				type: "line",
				field: "mort_num",
				color: "black",
        markers: { size: 4},
				tooltip: {
					visible: true,
					template: "Total TB deaths (#= category #): #= tb_format_thou_2(value) #"
				}
			},{
				type: "rangeArea",
				fromField: "mort_lo_num",
				toField: "mort_hi_num",
				color: "black",
				tooltip: {
					visible: true,
				  template: "95% uncertainty interval (#= category #): #= tb_format_thou_2(value.from) #\u2013#= tb_format_thou_2(value.to) #"
				}
			},{
        type: "line",
        dashType: "dash",
        field: "mort_milestone",
        color: "grey",
        markers: {
             size: 0,
             opacity: 0
           },
			tooltip: {
				visible: false
			}
      },],      
      
			valueAxis: {
        labels: {
					template: "#= axis_spacer(value) #"
				},
				title: {
					text: "Total TB deaths per year",
					visible: true
				},
       min: 0,
        axisCrossingValue: 0,
				line: {
					visible: false
				}
			},      

			categoryAxis: {
				field: "year",
				labels: {
					rotation: 0,
          step: 2
				},
				majorGridLines: {
					visible: false
				},

				title: {
					text: "Year",
					visible: true
				}
			}

		});
}




function createFig_1_2_9(fig_ID, data, filter, min) {
  
		$(fig_ID).kendoChart({		
      dataSource: data,			
      chartArea: {
				height: 400
			},	
			title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif",
        align: "center"
			},
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "bar",
        stack: true,
        gap: 0.2
			},
			series: [{
				field: "M",
				color: "#F4A81D",
        tooltip: {
				visible: true,
				template: "Estimated number of deaths in males aged #= category # years: #= tb_format_thou_2(dataItem.M)#"
			}
			},{
				field: "F",
				color: "#6363C0",
        tooltip: {
				visible: true,
				template: "Estimated number of deaths in females aged #= category # years: #= tb_format_thou_2(dataItem.F*(-1))#"
			}
			},
              ],
			valueAxis: {
				labels: {
				template:  "#= kendo.toString(Math.abs(value),'n0').replace(/,/g, ' ') #",
				step: 2
				},
        title: {
					text: "Number of deaths"
				},
				line: {
					visible: false
				},
        axisCrossingValue: min,
        min: min
			},
			categoryAxis: {
				field: "age",
				labels: {
					rotation: "auto"
				},
        title: {
					text: "Age group (years)"
				},
				majorGridLines: {
					visible: false
				}			}
		});
}


```


```{js, echo=FALSE}

$(document).ready(function () {
createFig_1_2_1a("#fig_1_2_1a");  
createFig_1_2_1b("#fig_1_2_1b");

createFig_1_2_2("#fig_1_2_2");

createFig_1_2_3("#fig_1_2_3",fig_1_2_3_data, "age",-100000);
createFig_1_2_3("#fig_1_2_3b",fig_1_2_3b_data, "acat",-100000);

createFig_1_2_4("#fig_1_2_4");
createFig_1_2_5("#fig_1_2_5");
createFig_1_2_6("#fig_1_2_6");  

createFig_1_2_7("#fig_1_2_7_EUR",fig_1_2_7_data,"European Region",0.1,10);
createFig_1_2_7("#fig_1_2_7_AFR",fig_1_2_7_data,"African Region",1,10);
createFig_1_2_7("#fig_1_2_7_EMR",fig_1_2_7_data,"Eastern Mediterranean Region",0.1,30);
createFig_1_2_7("#fig_1_2_7_AMR",fig_1_2_7_data,"Region of the Americas",0.1,4);
createFig_1_2_7("#fig_1_2_7_WPR",fig_1_2_7_data,"Western Pacific Region",0.1,20);
createFig_1_2_7("#fig_1_2_7_SEAR",fig_1_2_7_data,"South-East Asia Region",0.1,80); 

createFig_1_2_81112("#fig_1_2_8_EUR",fig_1_2_8_data,"European Region",400,19e3,1.4);
createFig_1_2_81112("#fig_1_2_8_AFR",fig_1_2_8_data,"African Region",400,300e3,1.4);
createFig_1_2_81112("#fig_1_2_8_EMR",fig_1_2_8_data,"Eastern Mediterranean Region",400,50e3,1.4);
createFig_1_2_81112("#fig_1_2_8_AMR",fig_1_2_8_data,"Region of the Americas",400,15e3,1.4);
createFig_1_2_81112("#fig_1_2_8_WPR",fig_1_2_8_data,"Western Pacific Region",400,60e3,1.4);
createFig_1_2_81112("#fig_1_2_8_SEAR",fig_1_2_8_data,"South-East Asia Region",400,400e3,1.4);


createFig_1_2_9("#fig_1_2_9_EUR",fig_1_2_9_data_eur,"European Region",-3000);
createFig_1_2_9("#fig_1_2_9_AFR",fig_1_2_9_data_afr,"African Region",-40000);
createFig_1_2_9("#fig_1_2_9_EMR",fig_1_2_9_data_emr,"Eastern Mediterranean Region",-10000);
createFig_1_2_9("#fig_1_2_9_AMR",fig_1_2_9_data_amr,"Region of the Americas",-4000);
createFig_1_2_9("#fig_1_2_9_WPR",fig_1_2_9_data_wpr,"Western Pacific Region",-20000);
createFig_1_2_9("#fig_1_2_9_SEAR",fig_1_2_9_data_sea,"South-East Asia Region",-60000);

createFig_1_2_81112("#fig_1_2_11_AGO",fig_1_2_11_data,"Angola",250,5e3,1.8);
createFig_1_2_81112("#fig_1_2_11_COG",fig_1_2_11_data,"Congo",250,1e3,2);
createFig_1_2_81112("#fig_1_2_11_IND",fig_1_2_11_data,"India",250,250e3,2);
createFig_1_2_81112("#fig_1_2_11_MNG",fig_1_2_11_data,"Mongolia",250,0.2e3,1.5);
createFig_1_2_81112("#fig_1_2_11_PAK",fig_1_2_11_data,"Pakistan",250,30e3,1.4);
createFig_1_2_81112("#fig_1_2_11_THA",fig_1_2_11_data,"Thailand",250,7e3,2);

createFig_1_2_81112("#fig_1_2_11_BGD",fig_1_2_11_data,"Bangladesh",250,20e3,1.8);
createFig_1_2_81112("#fig_1_2_11_PRK",fig_1_2_11_data,"Democratic People's Republic of Korea",250,5e3,2);
createFig_1_2_81112("#fig_1_2_11_IDN",fig_1_2_11_data,"Indonesia",250,60e3,1.4);
createFig_1_2_81112("#fig_1_2_11_MOZ",fig_1_2_11_data,"Mozambique",250,5e3,2);
createFig_1_2_81112("#fig_1_2_11_PNG",fig_1_2_11_data,"Papua New Guinea",250,2e3,2);
createFig_1_2_81112("#fig_1_2_11_UGA",fig_1_2_11_data,"Uganda",250,8e3,1.7);

createFig_1_2_81112("#fig_1_2_11_BRA",fig_1_2_11_data,"Brazil",250,4e3,1.6);
createFig_1_2_81112("#fig_1_2_11_COD",fig_1_2_11_data,"Democratic Republic of the Congo",250,25e3,1.6);
createFig_1_2_81112("#fig_1_2_11_KEN",fig_1_2_11_data,"Kenya",250,15e3,2);
createFig_1_2_81112("#fig_1_2_11_MMR",fig_1_2_11_data,"Myanmar",250,10e3,2);
createFig_1_2_81112("#fig_1_2_11_PHL",fig_1_2_11_data,"Philippines",250,15e3,1.6);
createFig_1_2_81112("#fig_1_2_11_TZA",fig_1_2_11_data,"United Republic of Tanzania",250,10e3,2);

createFig_1_2_81112("#fig_1_2_11_CAF",fig_1_2_11_data,"Central African Republic",250,2e3,2);
createFig_1_2_81112("#fig_1_2_11_ETH",fig_1_2_11_data,"Ethiopia",250,10e3,2);
createFig_1_2_81112("#fig_1_2_11_LSO",fig_1_2_11_data,"Lesotho",250,3e3,2);
createFig_1_2_81112("#fig_1_2_11_NAM",fig_1_2_11_data,"Namibia",250,1e3,2);
createFig_1_2_81112("#fig_1_2_11_SLE",fig_1_2_11_data,"Sierra Leone",250,2e3,2);
createFig_1_2_81112("#fig_1_2_11_VNM",fig_1_2_11_data,"Viet Nam",250,5e3,2);

createFig_1_2_81112("#fig_1_2_11_CHN",fig_1_2_11_data,"China",250,25e3,1.6);
createFig_1_2_81112("#fig_1_2_11_GAB",fig_1_2_11_data,"Gabon",250,0.5e3,2);
createFig_1_2_81112("#fig_1_2_11_LBR",fig_1_2_11_data,"Liberia",250,1e3,2);
createFig_1_2_81112("#fig_1_2_11_NGA",fig_1_2_11_data,"Nigeria",250,60e3,1.4);
createFig_1_2_81112("#fig_1_2_11_ZAF",fig_1_2_11_data,"South Africa",250,20e3,2);
createFig_1_2_81112("#fig_1_2_11_ZMB",fig_1_2_11_data,"Zambia",250,4e3,2);

createFig_1_2_81112("#fig_1_2_12_KHM",fig_1_2_12_data,"Cambodia",250,2e3,2);
createFig_1_2_81112("#fig_1_2_12_RUS",fig_1_2_12_data,"Russian Federation",250,5e3,2);
createFig_1_2_81112("#fig_1_2_12_ZWE",fig_1_2_12_data,"Zimbabwe",250,3e3,2);
});  

```


