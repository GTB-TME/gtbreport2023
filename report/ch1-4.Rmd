--- 
title: "Section 1.4 TB prevalence surveys " 
author: "Irwin Law, with some tweaks by Hazim Timimi and Taku Yamanaka" 
date: "`r Sys.Date()`" 
time: "`r Sys.time()`"
knit: (function(inputFile, encoding) {
      out_dir <- "./local";
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_dir=file.path(dirname(inputFile), out_dir))})
output:  
  html_fragment:
    # Do not include a table of contents
    toc: no
    # Set standard figure width to 12 inches
    fig_width: 12
    # Do not write figure captions
    fig_caption: FALSE
    # Don't embed external resources (stylesheets, JS libraries) in the output 
    self_contained: FALSE


# To run this file and store output as html:
# rmarkdown::render(here::here("report/ch1-4.rmd"), output_file = "ch1-4.html", output_dir = here::here("report/local/"))
--- 


```{r setup, include=FALSE}
# Set chunk options.
# Results "asis" is useful to output markdown from a function
# Suppress messages, warnings and also the ## at the beginning of printed text

knitr::opts_chunk$set(echo = FALSE, 
                      results = "asis",
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE)  # TEMP error=TRUE for debugging!

# Kill any attempt at using factors, unless we explicitly want them!
options(stringsAsFactors=FALSE)

# Set output options ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

# TEMPORARY: Show P:N ratios?
show_pn_ratios <- TRUE

# Show static chart in addition to Kendo chart?
show_static <- FALSE

# Switch whether to show figure which is a png image
show_figure <- TRUE

# Save underlying data files as CSV and charts as PDF files?
pdf_csv_folder = here::here("report/local/figures/ch1-4")
save_csv <- TRUE
save_pdf <- TRUE
save_cairo = TRUE

# Create the output folder (only if it doesn't yet exist)
dir.create(pdf_csv_folder, showWarnings = FALSE, recursive = TRUE)


# Load packages ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

library(dplyr)
library(ggplot2)
library(tidyverse)
library(tidyr)
library(RColorBrewer)
library(whomap)
library(gtbreport)
library(jsonlite)
library(here)


# Load R functions ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

source(here("import/load_gtb.R"))
source(here("report/functions/country_region_lists.R"))
source(here("report/functions/NZ.R"))
source(here("report/functions/html_links.R"))
source(here("report/functions/output_ggplot.R"))


# Get the data for this chapter ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

country  <- load_gtb("cty")  
prev <- load_gtb("svy.prev") 
cases <- load_gtb("svy.prevcases")

# !!!!! NEED TO SORT THIS OUT!!!!!! since iso2 is not used in anywhere in this script, this is not required
# if (show_pn_ratios==TRUE) {
#   prev_notif <- get_timestamped_csv('prev_notif', prev_notif_csv_datestamp)  %>% fix_namibia()
# }

```


```{r css_js}
# Add standard stylesheets and javascript to support kendo
cat(writeLines(readLines(here("report/resources/headers.htm"))))
```



# 1.4 National TB prevalence surveys

<span class="red">**_Draft! Prepared `r Sys.time()`` _ using prevalence survey results from the database files and Irwin's prevalence:notification CSV file dated 2023-07-03_**</span>


## Rationale: why are surveys needed? 

To reliably track the burden of tuberculosis (TB) disease in terms of TB incidence and TB mortality from subnational to global levels, the ultimate goal is that all countries can rely on data routinely collected through a) national disease surveillance systems and b) vital registration (VR) systems in which causes of death are coded according to the international classification of diseases (ICD). 

Currently, all countries have national systems for notification (i.e. reporting) of people diagnosed with TB and almost all countries report TB case notification data to the World Health Organization (WHO) on an annual basis (<span class="red">Section 2.1</span>). However, in many countries (including most high TB burden countries) the number of notified cases each year is not a good proxy for the actual number of people who develop TB disease, for two reasons. The first is underreporting of people diagnosed with TB, especially in countries with large private sectors or in which people with TB seek care in public facilities that are not linked to the national TB programme and its associated reporting systems. The second is underdiagnosis, especially in countries with geographic or financial barriers to seeking health care. Many countries (including most high TB burden countries) do not have established national VR systems of high quality and coverage that can be used to reliably monitor the number of deaths and their cause (`r ref_lnk("1")`). 

In countries with a relatively high burden of TB disease that do not yet have national disease notification systems or national VR systems with cause-of-death data that are of sufficiently high quality and coverage, national TB prevalence surveys are the best way to directly measure the burden of TB disease in the population (`r ref_lnk("2&#8211;4")`). In terms of disease burden, WHO currently recommends consideration of surveys according to previously documented epidemiological criteria  (`r ref_lnk("3, 4")`).  


## What is measured in a survey? 

National TB prevalence surveys can provide a reliable measurement of the number of people in the population with bacteriologically confirmed pulmonary TB at a given point in time, and the distribution of these cases by age and sex. In addition, repeat surveys allow assessment of trends, and of the impact of interventions to reduce the burden of disease in the period since the last survey. WHO recommends that surveys focus on people aged 15 years or over (`r ref_lnk("2")`).  


## How can survey results be used? 

Results can be used to inform national estimates of TB incidence in all age groups, and can thus help to track progress towards the milestones and targets for reductions in TB incidence set in the End TB Strategy (<span class="red">Section 1.1</span>). Previously, survey results were also important for the assessment of progress towards global, regional and national targets for reductions in TB prevalence between 1990 and 2015. 

For these reasons, the implementation of national TB prevalence surveys in 22 priority countries (referred to as global focus countries, GFCs) was one of three strategic areas of work defined by the WHO Global Task Force on TB Impact Measurement (the Task Force) for the period 2007&#8211;2015 (`r ref_lnk("2, 3")`). National TB prevalence surveys were retained within the Task Force's updated strategic areas of work after 2015 (`r ref_lnk("4, 5")`). 

Other benefits of prevalence surveys include that they can be used to document health care seeking behaviour in the public and private sectors, assess variation in underreporting or underdiagnosis of TB by age and sex (using the ratio of prevalence to notifications), and quantify the extent of underreporting of people diagnosed with TB to national authorities. Findings can help to inform the development or improvement of TB case finding, diagnosis and treatment interventions. 

## Status of progress 

Between 2000 and August 2023, a total of 43 national TB prevalence surveys in 34 countries were implemented; of these, 40 used the screening and diagnostic methods recommended by WHO (`r lnk("Fig. 1.4.1")`). These 34 countries comprised 18 in Africa and 25 in Asia, and 20 of the 22 GFCs. Five countries implemented repeat surveys: China, Cambodia, Myanmar, the Philippines and Viet Nam. Timor-Leste started its first survey in December 2022, and Cambodia started its third survey in July 2023 (`r lnk("Fig. 1.4.2")`).

A growing number of countries are actively interested in implementing a repeat prevalence survey in the next 1&#8211;3 years: Ethiopia, Ghana, Malawi, Nigeria, Uganda, the United Republic of Tanzania, Zambia and Zimbabwe in Africa; and Indonesia, Pakistan and Thailand in Asia.  


### `r anch("Fig. 1.4.1")`<span class="red">Fig. 1.4.1</span> National surveys of the prevalence of TB disease, 2000&#8211;2023 
<div class="subhead">The year in which most field operations were implemented is shown. African countries in <span style="color:#BF3EFF">purple</span>, and Asian countries in <span style="color:#66CD00">green</span>.</div> 


```{r eval=show_figure, fig.alt="Timeline of national TB prevalence surveys implemented since 2000", out.width = '60%'}

knitr::include_graphics("./images/fig141.png")

```

<div class="footnote">^a^ The survey in Indonesia (2004) did not use chest X-ray to screen individuals for sputum submission.<br>
^b^ The surveys in Bangladesh (2008) and Eritrea (2005) collected sputum samples from all individuals (aged &#8805;15 years), and did not use chest X-ray and/or a symptom questionnaire to screen individuals for sputum submission.<br>
</div>

<br />


### `r anch("Fig. 1.4.2")`<span class="red">Fig. 1.4.2</span> Countries in which national population-based surveys of the prevalence of TB disease have been implemented using WHO recommended screening and diagnostic methods since 2000 or are planned (status in August 2023)^a^

```{r fig_1.4.2, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png',  fig.alt="Map of countries involved in national TB prevalence surveys"}

tbps <- prev %>%
  select(country, year, iso3)%>%
  filter(year>2006)%>%
  group_by(country) %>%
  filter(year == max(year))%>%
  arrange(year, country)

df1<- data.frame(
    country = I(c("Cambodia", "Ethiopia", "Ghana", "Malawi", "Nigeria", "Uganda", "United Republic of Tanzania", "Zambia", "Zimbabwe", "Indonesia", "Pakistan", "Thailand", "Timor-Leste", "China","Myanmar","Philippines","Viet Nam", "India")),
    var = c("Repeat survey ongoing", "Repeat survey planned","Repeat survey planned","Repeat survey planned","Repeat survey planned","Repeat survey planned","Repeat survey planned","Repeat survey planned","Repeat survey planned","Repeat survey planned","Repeat survey planned","Repeat survey planned", "First survey ongoing", "rpt", "rpt", "rpt", "rpt","One survey completed"),
iso3=c("KHM","ETH","GHA","MWI","NGA","UGA","TZA","ZMB","ZWE","IDN","PAK", "THA", "TLS", "CHN","MMR", "PHL","VNM", "IND"))

df1$var <- str_replace(df1$var, "rpt", "\u22652 surveys completed")

f1_4_2_data <- merge(tbps, df1, all=TRUE)
f1_4_2_data[is.na(f1_4_2_data)] <- "One survey completed"

f1_4_2_plot <- whomap(f1_4_2_data, colours= c("#3088BF","#4EC26D","#BDD7E7","#BF1B93","#F2AEB4"), na.col="#FFFFFF",  na.label = "No survey planned", water.col = "white") 

output_ggplot(f1_4_2_plot, f1_4_2_data, show_static = TRUE, pdf_csv_folder, save_csv, save_pdf, save_cairo)

```
 <div class="footnote"> ^a^ Screening included a chest X-ray and an interview about symptoms; at least culture was used to confirm diagnosis. The most recent surveys in Bangladesh, Eswatini, Kenya, Lesotho, Myanmar, Mozambique, Namibia, Nepal, the Philippines, South Africa and Viet Nam used both culture and Xpert assays for diagnosis. Repeat survey planned: a country has developed a protocol (e.g. Pakistan) or expressed strong interest in conducting a repeat TB prevalence survey. One survey completed: a survey that was conducted in accordance with WHO recommendations included in _Tuberculosis prevalence surveys: a handbook (2011)_ and at least a preliminary report has been published. &#8805; two surveys completed: countries that have conducted at least two national surveys in which participants were screened with chest X-ray, and (at least) culture was used to diagnose TB.</div> 


## Survey findings and implications 

Surveys have showed that the estimated prevalence of bacteriologically confirmed pulmonary TB per 100 000 population aged 15 years or over was high in many countries, but there was also considerable variation (`r lnk("Fig. 1.4.3")`). 

### `r anch("Fig. 1.4.3")`<span class="red">Fig. 1.4.3</span> Estimates of the prevalence of bacteriologically confirmed pulmonary TB in surveys completed 2007-2021^a^
```{r  fig_1.4.3, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png',  fig.alt="Map of countries involved in national TB prevalence surveys"}

f1_4_3_data <- prev  %>%
  filter(year >= 2006) %>%
  filter(year != 2008) %>% #this removes Bangladesh 2008 for now
  filter(case_type=="b") %>%
  filter(sex=="a") %>%
  filter(age_group=="15plus")%>%
  filter(area_type=="a")%>%
  
  # Get the region for each country
  inner_join(select(country, iso2, g_whoregion), by="iso2") %>% 
  
  # Identify Africa and Asia surveys
  mutate(region = ifelse(g_whoregion == "AFR", "Africa", "Asia")) %>% 
  
  # Tweak Sudan because it is in EMR not AFR!
  mutate(region = ifelse(iso2 == "SD", "Africa", region)) %>% 
  
  select(region, country, year, prev, prev_lo, prev_hi) %>%
  arrange(prev)
  
# Change labels of countries with multiple surveys
f1_4_3_data$country[f1_4_3_data$country == "Philippines" &  f1_4_3_data$year == 2007] <- "Philippines (2007)"
f1_4_3_data$country[f1_4_3_data$country == "Philippines" &  f1_4_3_data$year == 2016] <- "Philippines (2016)"

f1_4_3_data$country[f1_4_3_data$country == "Myanmar" &  f1_4_3_data$year == 2009] <- "Myanmar (2009\u20132010)"
f1_4_3_data$country[f1_4_3_data$country == "Myanmar" &  f1_4_3_data$year == 2018] <- "Myanmar (2018)"

f1_4_3_data$country[f1_4_3_data$country == "Viet Nam" &  f1_4_3_data$year == 2007] <- "Viet Nam (2006\u20132007)"
f1_4_3_data$country[f1_4_3_data$country == "Viet Nam" &  f1_4_3_data$year == 2018] <- "Viet Nam (2018)"


f1_4_3_plot <- qplot(prev, reorder(country, prev), data=f1_4_3_data, geom='point', size=I(3), colour=I('skyblue'), 
            fill=I('skyblue')) +
  geom_segment(aes(x=prev_lo, xend=prev_hi, y=country, yend=country), colour=I('skyblue'), size=I(4)) +
  
  geom_point(aes(prev, country), colour=I('skyblue'), size=I(5), pch=3) +
  
  facet_wrap(~region, nrow=1, scales='free_y') +
  
  scale_x_log10(breaks=c(100, 200, 500, 1000), labels=c("100","200","500","1000")) +
  
  xlab('Prevalence per 100 000 population (log scale)') + ylab('') +
  
  theme_gtb(base_size=11)

output_ggplot(f1_4_3_plot, f1_4_3_data, show_static, pdf_csv_folder, save_csv, save_pdf, save_cairo)


```
<div class="row">
<div class="col-md-6">
<div id="fig_1_4_3_africa"></div>
</div>
<div class="col-md-6">
<div id="fig_1_4_3_asia"></div>
</div>
</div>

<div class="footnote"> ^a^ The measured prevalence of bacteriologically confirmed pulmonary TB was higher in the 2017 survey in Viet Nam compared with 2007. However, this was due to more diagnostic testing with more sensitive methods. When results based on the same method were compared, prevalence was estimated to have fallen between 2007 and 2017.</div> 

<br />
In African countries, prevalence ranged from 119 (95% confidence interval [CI]: 79&#8211;160) per 100 000 population in Rwanda (in 2012) to 852 (95% CI: 679&#8211;1026) per 100 000 population in South Africa (in 2017). In Asian countries, prevalence ranged from 119 (95% CI: 103&#8211;135) per 100 000 population in China (in 2010) to 1159 (95% CI: 1016&#8211;1301) per 100 000 population in the Philippines (in 2016). 

In most Asian countries and some African countries, prevalence increased with age (`r lnk("Fig. 1.4.4")`, `r lnk("Fig. 1.4.5")`).

### `r anch("Fig. 1.4.4")`<span class="red">Fig. 1.4.4</span> Estimated age-specific prevalence of bacteriologically confirmed pulmonary TB for surveys implemented in Africa, 2010&#8211;2019^a^
<div class="subhead">The <span class="red">red</span> line denotes the best estimate and the <span style="color:#4ABAFC">blue</span> shaded areas are the 95% confidence intervals.</div> 

```{r fig_1.4.4, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=10,  fig.alt="Panel plot of age-specific prevalence in African surveys"}

f1_4_4_and_5_data <- prev  %>%
  # Get the region for each country
  inner_join(select(country, iso2, g_whoregion), by="iso2") %>% 
  
  # Identify Africa and Asia surveys
  mutate(region = ifelse(g_whoregion == "AFR", "Africa", "Asia")) %>% 
  
  # Tweak Sudan because it is in EMR not AFR!
  mutate(region = ifelse(iso2 == "SD", "Africa", region)) %>% 
  
  # Restrict to detailed age groups for bac-confirmed cases (except for Tanzania, which should be smear-positives)
  filter(case_type == "b" | (case_type == "s" & iso2 == "TZ")) %>%
  filter(sex == "a") %>%
  filter(age_group!="15plus")%>%
  filter(age_group!="all") %>% 
  filter(year > 2006)
  
# Add codes for the age groups
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "15_24"] <- 1
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "25_34"] <- 2
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "35_44"] <- 3
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "45_54"] <- 4
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "55_64"] <- 5
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "65plus"] <- 6
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "15_34"] <- 7
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "35_54"] <- 8
f1_4_4_and_5_data$code[f1_4_4_and_5_data$age_group == "55plus"] <- 9


# Plot restricted to surveys in Africa
f1_4_4_data <- filter(f1_4_4_and_5_data, region == "Africa")

f1_4_4_plot <-   ggplot(data = f1_4_4_data, aes(x=code, y=prev)) +  
  geom_line(data = f1_4_4_data, aes(y = prev),colour = "#FC1C1E", size=1) +
  geom_ribbon(data = f1_4_4_data, aes(ymin = prev_lo, ymax = prev_hi),alpha = 0.5, fill="#CCE8FA") +
  facet_wrap(~country, nrow=5, scales="free",
             # Use the labeller function to make sure long country names are wrapped in panel headers
             labeller = label_wrap_gen(width = 25)) +
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9),
                     labels=c("15-24","25-34","35-44","45-54","55-64","\u226565","15-34","35-54","\u226555")) + 
  ylab('Prevalence per 100 000 population') +
  xlab('Age groups (years)') +
  scale_y_continuous(expand = c(0, 0)) +
  theme_gtb()

output_ggplot(f1_4_4_plot, f1_4_4_data, show_static, pdf_csv_folder, save_csv, save_pdf, save_cairo, pdf_height = 10)

```

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_4_SWZ"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_ETH"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_GMB"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_4_GHA"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_KEN"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_LSO"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_4_MWI"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_MOZ"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_NAM"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_4_NGA"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_RWA"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_ZAF"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_4_SDN"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_UGA"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_TZA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_4_ZMB"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_4_ZWE"></div>
</div>
<div class="col-md-4"></div>
</div>

<div class="footnote"> ^a^ Surveys in Gambia and Rwanda were restricted to only three age group categories because the number of survey cases was low. Bacteriologically confirmed TB cases could not be verified for the United Republic of Tanzania, so the prevalence of smear-positive pulmonary TB are shown instead.</div> 

### `r anch("Fig. 1.4.5")`<span class="red">Fig. 1.4.5</span> Estimated age-specific prevalence of bacteriologically confirmed pulmonary TB for surveys implemented in Asia, 2007&#8211;2021  
<div class="subhead">The <span class="red">red</span> line denotes the best estimate and the <span style="color:#4ABAFC">blue</span> shaded areas are the 95% confidence intervals.</div> 

```{r fig_1.4.5, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=12,  fig.alt="Panel plot of age-specific prevalence in Asian surveys"}

# Filter on Asian surveys
f1_4_5_data <- filter(f1_4_4_and_5_data, region == "Asia")

f1_4_5_data <- within(f1_4_5_data, country[country == 'Viet Nam' & year == 2007] <- 'Viet Nam (2006\u20132007)')
f1_4_5_data <- within(f1_4_5_data, country[country == 'Viet Nam' & year == 2018] <- 'Viet Nam (2018)')

f1_4_5_data <- within(f1_4_5_data, country[country == 'Philippines' & year == 2007] <- 'Philippines (2007)')
f1_4_5_data <- within(f1_4_5_data, country[country == 'Philippines' & year == 2016] <- 'Philippines (2016)')

f1_4_5_data <- within(f1_4_5_data, country[country == 'Myanmar' & year == 2009] <- 'Myanmar (2009\u20132010)')
f1_4_5_data <- within(f1_4_5_data, country[country == 'Myanmar' & year == 2018] <- 'Myanmar (2018)')


f1_4_5_plot <-ggplot(data = f1_4_5_data, aes(x=code, y=prev)) +  
    geom_line(data = f1_4_5_data,aes(y = prev),colour = "#FC1C1E", size=1) +
    geom_ribbon(data = f1_4_5_data,aes(ymin = prev_lo, ymax = prev_hi),alpha = 0.5, fill="#CCE8FA") +
    facet_wrap(~country, nrow=5, scales="free",
             # Use the labeller function to make sure long country names are wrapped in panel headers
             labeller = label_wrap_gen(width = 25)) +
    scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9),
                     labels=c("15\u201324","25\u201334","35\u201344","45\u201354","55\u201364","\u226565","15-34","35-54","\u226555")) + 
    scale_y_continuous(expand = c(0, 0)) +
    ylab('Prevalence per 100 000 population') +
    xlab('Age groups (years)') +
    theme_gtb()

output_ggplot(f1_4_5_plot, f1_4_5_data, show_static, pdf_csv_folder, save_csv, save_pdf, save_cairo, pdf_height = 10)

```

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_5_BGD"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_KHM"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_CHN"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_5_PRK"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_IND"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_IDN"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_5_LAO"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_MNG"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_MMR09"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_5_MMR18"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_NPL"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_PAK"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_5_PHL07"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_PHL16"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_THA"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_1_4_5_VNM06"></div>
</div>
<div class="col-md-4">
<div id="fig_1_4_5_VNM18"></div>
</div>
<div class="col-md-4"></div>
</div>
</div>

<br/>
As transmission declines, more incident cases arise from old (remote) rather than recent infection. Therefore, a pattern in which prevalence increases with age suggests that transmission is falling. It is encouraging that prevalence surveys indicated that transmission is potentially declining in many Asian countries and in several African countries (e.g. Ghana, Lesotho, Malawi, Mozambique, Rwanda and the United Republic of Tanzania). Elsewhere, surveys suggested considerable community transmission; peaks in many African countries in the age groups 35&#8211;44 or 45&#8211;54 years also reflect the impact of the HIV epidemic. 

A striking finding across all surveys was the much higher burden of TB disease in men compared with women (`r lnk("Fig. 1.4.6")`). The male to female (M:F) ratio of bacteriologically confirmed pulmonary cases in surveys completed in 2007-2019 ranged from 1.2 (in Ethiopia) to 4.5 (in Viet Nam); in most countries it was in the range 2&#8211;4. These findings mean that men typically account for about 66-75% of the burden of TB disease in adults. 

### `r anch("Fig. 1.4.6")`<span class="red">Fig. 1.4.6</span> The male to female ratio of bacteriologically confirmed adult TB cases detected in prevalence surveys implemented 2007&#8211;2021^a^

```{r fig_1.4.6, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=8, fig.alt="Panel plot of sex ratio from national TB prevalence surveys" }

f1_4_6_data <- prev  %>%
  
  # Restrict to female/male disaggs for bac-confirmed cases (except for Tanzania, which should be smear-positives)
  filter(case_type == "b" | case_type == "s" & iso2 == "TZ") %>% 
  filter(year >= 2006) %>%
  filter(year != 2008) %>% #this removes Bangladesh 2008 for now
  filter(sex != "a") %>%
 
  select(country, year, case_type, age_group, sex, prev)

# Change labels of countries with multiple surveys
f1_4_6_data$country <- as.character(f1_4_6_data$country) 

f1_4_6_data$country[f1_4_6_data$country == "Myanmar" &  f1_4_6_data$year == 2009] <- "Myanmar (2009\u20132010)"
f1_4_6_data$country[f1_4_6_data$country == "Myanmar" &  f1_4_6_data$year == 2018] <- "Myanmar (2018)"

f1_4_6_data$country[f1_4_6_data$country == "Philippines" &  f1_4_6_data$year == 2007] <- "Philippines (2007)"
f1_4_6_data$country[f1_4_6_data$country == "Philippines" &  f1_4_6_data$year == 2016] <- "Philippines (2016)"

f1_4_6_data$country[f1_4_6_data$country == "Viet Nam" &  f1_4_6_data$year == 2007] <- "Viet Nam (2006\u20132007)"
f1_4_6_data$country[f1_4_6_data$country == "Viet Nam" &  f1_4_6_data$year == 2018] <- "Viet Nam (2018)"

## Long to wide
f1_4_6_data <- f1_4_6_data %>% 
  pivot_wider(id_cols = c(country, year, case_type),
              names_from = sex,
              values_from = prev) %>% 
  
  # Calculate the male:female ratio
  mutate(ratio = m / f) %>% 
  
    select(country, year, ratio)

f1_4_6_plot <- ggplot(f1_4_6_data, aes(x=country, y=ratio)) +
    geom_bar(stat="identity",  width=.8, fill="#218CDF") +
    coord_flip() +
    xlab ("") +
    ylab("Sex ratio (male:female)") +
    #theme_bw(base_size=10) +
    scale_x_discrete(limits = f1_4_6_data$country[order(f1_4_6_data$ratio)]) +
    geom_hline(yintercept = c(1,2,3,4),linetype="dashed", colour="grey")+
    theme_gtb()

output_ggplot(f1_4_6_plot, f1_4_6_data, show_static, pdf_csv_folder, save_csv, save_pdf, save_cairo)

```
<div id="fig_1_4_6"></div>

<div class="footnote">^a^ Due to laboratory challenges during the survey in the United Republic of Tanzania, it was only possible to directly estimate the prevalence of smear-positive (as opposed to bacteriologically confirmed) pulmonary TB.</div> 

<br />
Ratios of prevalence to notifications (P:N, expressed in years) suggest marginally higher detection and reporting gaps in Asia compared with Africa, and lower detection and reporting gaps among women compared with men (`r lnk("Fig. 1.4.7")`, `r lnk("Fig. 1.4.8")`). The combination of a higher disease burden in men and larger gaps in detection and reporting indicates a need for strategies to improve access to and use of health services among men (`r ref_lnk("6")`).  

### `r anch("Fig. 1.4.7")`<span class="red">Fig. 1.4.7</span> The prevalence to notification (P:N) ratio of adult TB cases in prevalence surveys implemented 2007&#8211;2021^a^  

```{r fig_1.4.7, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=8, fig.alt="Panel plot of P:N ratio from national TB prevalence surveys", eval=show_pn_ratios }

# Get data file created by Irwin in previous years
# Note from Hazim: I tried to derive all data from the database but couldn't
# because after 2013 we didn't collect age-disaggregated data restricted to bac-confirmed cases
# We think that Irwin and Sayori got the notification numbers in the file directly from
# NTPs when compiling the prevalence survey book. Hazim has no trace of this so for the moment
# taking these data on trust. Not very satisfactory.
# Notification data from 2013 uses newrel_m15plus and newrel_f15plus

f1_4_7_and_8_data  <-  read.csv(here::here("./report/ch1_data/prev_notif_2023-07-03.csv")) %>% 
  mutate(country = ifelse(country=="Viet Nam (2006-2007)", "Viet Nam (2006\u20132007)", country),
         country = ifelse(country=="Myanmar (2009-2010)", "Myanmar (2009\u20132010)", country)) %>%

  # Convert notifications to rates per 100 000 population
  mutate(notif_100k = notified * (1e5 / pop),
         notif_100k_f  = f_notified * (1e5 / f_pop),
         notif_100k_m  = m_notified * (1e5 / m_pop)) %>% 
  
  # Calculate p:n ratios
  mutate(pn = ifelse(NZ(notif_100k) > 0, prev / notif_100k, NA),
         pn_f = ifelse(NZ(notif_100k_f) > 0, f_prev / notif_100k_f, NA),
         pn_m = ifelse(NZ(notif_100k_m) > 0, m_prev / notif_100k_m, NA)) %>% 
  
  # Remove unnecessary variables
  select(country, year, pn, pn_f, pn_m)

f1_4_7_plot <-ggplot(f1_4_7_and_8_data, aes(x = pn, y = country)) +
        #geom_segment(aes(x = 0, y = country, xend = pn, yend = country)) +
      geom_point(size = 3, colour="red") +
      ylab ("") +
      xlab("P:N ratio") +
      scale_y_discrete(limits = f1_4_7_and_8_data$country[order(f1_4_7_and_8_data$pn)]) +
    theme_gtb()

output_ggplot(f1_4_7_plot, f1_4_7_and_8_data, show_static, pdf_csv_folder, save_csv, save_pdf, save_cairo)

```
<div id="fig_1_4_7"></div>

<div class="footnote">^a^ The P:N ratio is for smear-positive pulmonary TB, except for Bangladesh, the Democratic People&#39;s Republic of Korea, Kenya, Myanmar (2018), Namibia (2018), Uganda, Viet Nam (2017) and Zimbabwe where it was based on bacteriologically confirmed pulmonary TB. Prevalence estimates are from a cross-sectional survey, and therefore only represent one point in time. Notification data are from the main year of the survey.</div> 

### `r anch("Fig. 1.4.8")`<span class="red">Fig. 1.4.8</span> The prevalence to notification (P:N) ratio by sex for adult TB cases in prevalence surveys implemented 2007&#8211;2021^a^
```{r fig_1.4.8, echo=FALSE, message=FALSE, warning=FALSE, results = "asis", dev = 'png', fig.height=8, fig.alt="Panel plot of P:N ratio by sex from national TB prevalence surveys", eval=show_pn_ratios }

f1_4_8_data <- f1_4_7_and_8_data %>% 

  # switch back to long format
  pivot_longer(cols = pn_f:pn_m,
               names_to = "sex",
               names_prefix = "pn_")


f1_4_8_plot <- ggplot(f1_4_8_data, aes(x=country, y=value, colour=sex)) +
  geom_point(stat="identity", size=3) +
  #geom_bar(stat="identity",  width=.8) +
  coord_flip() + 
  scale_color_manual(values = c("f" = '#6363C0','m' = '#F4A81D'),
                     labels = c("Female", "Male")) +
  xlab("") +
  ylab("P:N ratio") +
  scale_x_discrete(limits = f1_4_8_data$country[order(f1_4_8_data$pn)]) +
  theme_gtb()


output_ggplot(f1_4_8_plot, f1_4_8_data, show_static, pdf_csv_folder, save_csv, save_pdf, save_cairo)

```
<div id="fig_1_4_8"></div>

<div class="footnote">^a^ The P:N ratio is for smear-positive pulmonary TB, except for Bangladesh, the Democratic People&#39;s Republic of Korea, Kenya, Myanmar (2018), Namibia (2018), Uganda, Viet Nam (2017) and Zimbabwe where it was based on bacteriologically confirmed pulmonary TB. Prevalence estimates are from a cross-sectional survey, and therefore only represent one point in time. Notification data are from the main year of the survey.</div> 


<br />
A large proportion of survey participants with bacteriologically confirmed pulmonary TB did not report symptoms during screening and were only tested for TB based on chest X-ray screening. This proportion was higher in Asian countries compared with African countries, and varied from 30% in Malawi to 86% in Myanmar (`r lnk("Fig. 1.4.9")`). The natural history of these individuals, their contribution to overall transmission on a population level, and implications for case-finding and treatment needs further exploration (`r ref_lnk("7, 8")`).


### `r anch("Fig. 1.4.9")`<span class="red">Fig. 1.4.9</span> Proportion of bacteriologically confirmed pulmonary TB cases detected in national TB prevalence surveys who did not report symptoms, 2007&#8211;2022
```{r fig_1.4.9, eval=show_pn_ratios, echo=FALSE, fig.alt="Bar chart of proprotion of TB cases not reporting symptoms from national TB prevalence surveys", fig.height=8, message=FALSE, warning=FALSE, dev='png', results="asis"}


# Restrict to those who are only cxr_abn_only 
f1_4_9_data <- cases  %>%
  filter(
  ((screen_group=="cxr_abn_only"|screen_group == "all") & case_type=="b" & age_group=="15plus" & sex=="a")|
  ((screen_group=="cxr_abn_only"|screen_group == "all") & country=="United Republic of Tanzania" & age_group=="15plus" & sex=="a") |
  ((screen_group=="cxr_abn_only"|screen_group == "all") & case_type=="b" & country=="Philippines" & age_group=="10plus" & sex=="a" & year=="2007") 
  ) %>%
  
  # Get the region for each country
  inner_join(select(country, iso2, g_whoregion), by="iso2") %>% 
  
  # Identify Africa and Asia surveys
  mutate(region = ifelse(g_whoregion == "AFR", "Africa", "Asia")) %>% 
  
  # Tweak Sudan because it is in EMR not AFR!
  mutate(region = ifelse(iso2 == "SD", "Africa", region)) %>% 
  
  select(region, country, year, screen_group, cases, case_type) %>% 
  arrange(region)
  

#Change country labels to differentiate repeat surveys
f1_4_9_data$country <- as.character(f1_4_9_data$country) 

f1_4_9_data$country[f1_4_9_data$country == "Philippines" &  f1_4_9_data$year == 2007] <- "Philippines (2007)"
f1_4_9_data$country[f1_4_9_data$country == "Philippines" &  f1_4_9_data$year == 2016] <- "Philippines (2016)"

f1_4_9_data$country[f1_4_9_data$country == "Viet Nam" &  f1_4_9_data$year == 2007] <- "Viet Nam (2006\u20132007)"
f1_4_9_data$country[f1_4_9_data$country == "Viet Nam" &  f1_4_9_data$year == 2018] <- "Viet Nam (2018)"

f1_4_9_data$country[f1_4_9_data$country == "Myanmar" &  f1_4_9_data$year == 2009] <- "Myanmar (2009\u20132010)"
f1_4_9_data$country[f1_4_9_data$country == "Myanmar" &  f1_4_9_data$year == 2018] <- "Myanmar (2018)"


## Long to wide

w <- reshape(f1_4_9_data, 
             timevar = "screen_group",
             idvar = c("country", "region"),
             direction = "wide")

w$prop<-(w$`cases.cxr_abn_only`/w$cases.all)*100

## Select only African surveys
f1_4_9_data_africa <-filter (w,region=="Africa") 

## Select only Asian surveys
f1_4_9_data_asia <-filter (w, region=="Asia") 


limits <- c(0, 100)
breaks <- seq(limits[1], limits[2], by=10)

f1_4_9_plot_africa <- ggplot(f1_4_9_data_africa, aes(country,prop)) +
  geom_bar( colour="black", fill="#6363C0", width=.8, stat="identity") +
  xlab ("") +
  ylab("Percentage") +
  theme_gtb () +
  scale_x_discrete(limits = f1_4_9_data_africa$country[order(f1_4_9_data_africa$prop)]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_hline(yintercept=50, linetype="dashed", colour="darkgrey")+ 
  facet_wrap(vars(region))+
  scale_y_continuous(limits=limits, breaks=breaks)+
  coord_flip()
# africa1

f1_4_9_plot_asia <- ggplot(f1_4_9_data_asia, aes(country,prop)) +
  geom_bar( colour="black", fill="#40BF73", width=.8, stat="identity") +
  xlab ("") +
  ylab("Percentage") +
  theme_gtb () +
  scale_x_discrete(limits = f1_4_9_data_asia$country[order(f1_4_9_data_asia$prop)]) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  geom_hline(yintercept=50, linetype="dashed", colour="darkgrey")+ 
  facet_wrap(vars(region))+
  scale_y_continuous(limits=limits, breaks=breaks)+
  coord_flip()
# asia1

f1_4_9_plot_africa<- ggplot_gtable(ggplot_build(f1_4_9_plot_africa))
f1_4_9_plot_asia <- ggplot_gtable(ggplot_build(f1_4_9_plot_asia))

# copy the plot height from p1 to p2
f1_4_9_plot_asia$heights <- f1_4_9_plot_africa$heights

# require(gridExtra)
# f1_4_9_plot <- grid.arrange(africa1, asia1, ncol=2, widths=c(3,3))
f1_4_9_plot <- cowplot::plot_grid(f1_4_9_plot_africa, f1_4_9_plot_asia, ncol = 2)

output_ggplot(f1_4_9_plot, f1_4_9_data, show_static, pdf_csv_folder, save_csv, save_pdf, save_cairo)

```

<div class="row">
<div class="col-md-6">
<div id="fig_1_4_9_africa"></div>
</div>
<div class="col-md-6">
<div id="fig_1_4_9_asia"></div>
</div>
</div>

<div class="footnote">^a^ </div> 

<br />


## For more information 

A WHO 2021 [publication](https://apps.who.int/iris/bitstream/handle/10665/341072/9789240022430-eng.pdf) provides full details about the results and lessons learned from the 25 national surveys implemented between 2007 and 2016 (`r ref_lnk("3")`). In addition, regional syntheses of survey results and lessons learned are available in journal articles (`r ref_lnk("9, 10")`). 

A document has been published in May 2023 that discusses the diagnostic algorithms to be used in future surveys (implemented from 2023 onwards) (`r ref_lnk("11")`). It provides the basis for recommendations on diagnostic algorithms to be included in the third edition of WHO guidance on national TB prevalence surveys which is scheduled for completion in 2023.


`r anch("refs")`

<hr style="border:1px solid gray20">

**References**

1. Mikkelsen L, Phillips DE, AbouZahr C, Setel PW, de Savigny D, Lozano R et al. A global assessment of civil registration and vital statistics systems: monitoring data quality and progress. Lancet. 2015;386(10001):1395-406 (https://www.ncbi.nlm.nih.gov/pubmed/25971218).

2. Tuberculosis prevalence surveys: a handbook (WHO/HTM/TB/2010.17). Geneva: World Health Organization; 2011 (https://iris.who.int/handle/10665/44481).

3. National tuberculosis prevalence surveys, 2007-2016. Geneva: World Health Organization; 2021 (https://iris.who.int/handle/10665/341072).

4. World Health Organization Global Task Force on TB Impact Measurement. Report of the sixth meeting of the full Task Force; 19-21 April 2016, Glion-sur-Montreux, Switzerland. Geneva: World Health Organization; 2016 (https://cdn.who.int/media/docs/default-source/hq-tuberculosis/global-task-force-on-tb-impact-measurement/meetings/2016-05/tf6_report.pdf?sfvrsn=8a9563a3_3).

5. Fact sheet on the WHO Global Task Force on TB Impact Measurement (May 2023). Geneva: World Health Organization; 2023 (https://www.who.int/publications/m/item/WHO-UCN-TB-2023.2).

6. Horton KC, MacPherson P, Houben RM, White RG, Corbett EL. Sex differences in tuberculosis burden and notifications in low- and middle-income countries: a systematic review and meta-analysis. PLoS Med. 2016;13(9):e1002119 (https://www.ncbi.nlm.nih.gov/pubmed/27598345).

7.	Kendall EA, Shrestha S, Dowdy DW. The Epidemiological Importance of Subclinical Tuberculosis. A Critical Reappraisal. Am J Respir Crit Care Med. 2021 Jan 15;203(2):168-174. doi: 10.1164/rccm.202006-2394PP. (https://pubmed.ncbi.nlm.nih.gov/33197210/)

8.	Richards AS, Sossen B, Emery JC, Horton KC, Heinsohn T, Frascella B et al. Quantifying progression and regression across the spectrum of pulmonary tuberculosis: a data synthesis study. Lancet Glob Health. 2023 May;11(5):e684-e692. doi: 10.1016/S2214-109X(23)00082-7. Epub 2023 Mar 23. (https://pubmed.ncbi.nlm.nih.gov/36966785/)

9.	Onozaki I, Law I, Sismanidis C, Zignol M, Glaziou P, Floyd K. National tuberculosis prevalence surveys in Asia, 1990-2012: an overview of results and lessons learned. Trop Med Int Health. 2015 Sep;20(9):1128-1145 (https://pubmed.ncbi.nlm.nih.gov/25943163).

10.	Law I, Floyd K, African TB Prevalence Survey Group. National tuberculosis prevalence surveys in Africa, 2008-2016: an overview of results and lessons learned. Trop Med Int Health. 2020 Nov;25(11):1308-1327 (https://pubmed.ncbi.nlm.nih.gov/32910557).

11.	National tuberculosis prevalence surveys: what diagnostic algorithms should be used in future? Geneva: World Health Organization; 2023 (https://iris.who.int/handle/10665/367909).



```{r js_functions}
# Insert javascript file containing common Kendo number formatting functions ----
cat(writeLines(readLines(here("report/resources/gtbr_js.htm"))))
```



<script type="text/javascript">

/* JSON data objects for the figures */

var fig_1_4_3_data = `r f1_4_3_data %>%  arrange(desc(prev)) %>% toJSON("rows")`;

var fig_1_4_4_data = `r f1_4_4_data %>% filter(!is.na(code)) %>%  mutate(age_group = factor(age_group, levels=c("15_24", "25_34", "35_44", "45_54", "55_64", "65plus", "15_34", "35_54", "55plus"), labels=c("15\u201324","25\u201334","35\u201344","45\u201354","55\u201364","\u226565","15\u201334","35\u201354","\u226555"))) %>% select(country, age_group, prev, prev_lo, prev_hi) %>% toJSON("rows")`;

var fig_1_4_5_data = `r f1_4_5_data %>% filter(!is.na(code)) %>%  mutate(age_group = factor(age_group, levels=c("15_24", "25_34", "35_44", "45_54", "55_64", "65plus", "15_34", "35_54", "55plus"), labels=c("15\u201324","25\u201334","35\u201344","45\u201354","55\u201364","\u226565","15\u201334","35\u201354","\u226555"))) %>% select(country, age_group, prev, prev_lo, prev_hi) %>% toJSON("rows")`;

var fig_1_4_6_data = `r f1_4_6_data %>%  arrange(desc(ratio)) %>% toJSON("rows")`;

var fig_1_4_78_data = `r f1_4_7_and_8_data %>%  arrange(desc(pn)) %>% toJSON("rows")`; 

var fig_1_4_9_data_africa = `r f1_4_9_data_africa %>% select(country, prop) %>% mutate(fifty=50) %>% arrange(desc(prop)) %>% toJSON("rows")`; 

var fig_1_4_9_data_asia = `r f1_4_9_data_asia %>% select(country, prop) %>% mutate(fifty=50)  %>% arrange(desc(prop)) %>% toJSON("rows")`; 

</script>


```{js, echo=FALSE}

/* Functions to create the figures */

/* Define a standard chart for 1.4.3 with a data filter for the region */
function createfig_1_4_3(div_ID, data, filter, title_text, color) {

	// Filter the dataset on the region variable
	dataJSON = data.filter( element => element.region == filter);

	$(div_ID).kendoChart({
		dataSource: dataJSON,
		chartArea: {
			height: 500
		},
		title: {
			text: title_text,
			color: "black",
			font: "bold 14px  Arial,Helvetica,sans-serif"
		},	
		legend: {
			visible: false
		},
		series: [{
      type: "bar",
			field: 0,
			opacity: 0
		}, {
      type: "line",
			field: "prev",
      errorLowField: "prev_lo",
      errorHighField: "prev_hi",
      errorBars: {
        endCaps: false,
        color: color, 
        line: { 
          width: 5 
        }
      },
      opacity: 0,
			color: color,
      markers: {
        visible: true,
        background: color,
        size: 10
      },
			tooltip: {
				visible: true,
        background: color,
				template: "#= category #: #= rounder(value, 2) #"
			}
			},{
				type: "rangeArea",
				fromField: "prev_lo",
				toField: "prev_hi",
				opacity: 0,
        color: color,
				tooltip: {
					visible: true,
          background: color,
				  template: "#= category #: 95% uncertainty interval  #= rounder(value.from, 2) #â€“#= rounder(value.to, 2) #"
				}
			}],

		valueAxis: {
			labels: {
				template: "#= axis_spacer(value) #"
			},
			title: {
				text: "Prevalence per 100 000 population\n(log scale)"
			},
			line: {
				visible: false
			},
			type: "log"
		},
		categoryAxis: {
			field: "country",
			labels: {
				rotation: "auto"
			}
		}
	});
}

function create_prev_age(div_ID, data, filter) {

	// Filter the dataset on the country variable
	dataJSON = data.filter( element => element.country == filter);

	$(div_ID).kendoChart({
		dataSource: dataJSON,
		chartArea: {
			height: 250
		},
		title: {
			text: filter,
			color: "black",
			font: "bold 14px  Arial,Helvetica,sans-serif"
		},	
		legend: {
			visible: false
		},
		series: [{
			name: "Prevalence",
			type: "line",
			field: "prev",
			color: "red",
			tooltip: {
				visible: true,
				format: "{0}",
				template: "Age group #= category # years: #= rounder(value, 2) #"
			}
		},{
			name: "Prevalence uncertainty bounds",
			type: "rangeArea",
			fromField: "prev_lo",
			toField: "prev_hi",
			color: "skyblue",
			tooltip: {
				visible: true,
				format: "{0}",
				template: "Age group #= category # years: 95% uncertainty interval #= rounder(value.from, 2)  #\u2013#= rounder(value.to, 2)  #"
			}
		}],
		valueAxis: {
			labels: {
				template: "#= axis_spacer(value) #"
			},
			title: {
				text: "Prevalence\nper 100 000 population"
			},
			line: {
				visible: false
			}
		},
		categoryAxis: {
			field: "age_group",
			majorGridLines: {
				visible: false
			},
			labels: {
				rotation: "auto"
			},
			title: {
				text: "Age group (years)"
			}			
		}
	});
}


/* Figures 1.4.6 and 1.4.7 are similar so define a standard chart function for them */
function create_ratio_bars(div_ID, data, description_text, field_name, dot_colour){

	$(div_ID).kendoChart({
		dataSource: data,
		chartArea: {
			height: 800
		},	
		legend: {
			visible: false
		},
		series: [{
			type: "bar",
			field: 0,
			opacity: 0
		}, {
  	type: "line",
		field: field_name,
	  opacity: 0,
		color: dot_colour,
	  markers: {
  	  visible: true,
  	  background: dot_colour,
  	  size: 8
  	},
		tooltip: {
			visible: true,
	    background: dot_colour,
			template: "#= category #: #= num_spacer(Number(value.toPrecision(2))) #"
		}
		}],
		valueAxis: {
			labels: {
				format: "{0}",
				rotation: "auto"
			},
			title: {
				text: description_text
			},
			line: {
				visible: false
			}
		},
		categoryAxis: {
			field: "country",
			labels: {
				rotation: "auto"
			},
			majorGridLines: {
				visible: true
			}
	  }
	});
}
	
	
function createfig_1_4_8() {
	$("#fig_1_4_8").kendoChart({
		dataSource: fig_1_4_78_data,
		chartArea: {
			height: 800
		},	
		legend: {
			position: "bottom"
		},
		seriesDefaults: {
			type: "bar"
		},
		series: [{
			type: "bar",
			field: 0,
			opacity: 0
		}, {
  	type: "line",
  	name: "Female",
		field: "pn_f",
	  opacity: 0,
		color: "#6363C0",
	  markers: {
  	  visible: true,
  	  background: "#6363C0",
  	  size: 8
  	},
		tooltip: {
			visible: true,
	    background: "#6363C0",
			template: "#= category # (#= series.name #): #=  num_spacer(Number(value.toPrecision(2)))  #"
		}
		}, {
  	type: "line",
  	name: "Male",
		field: "pn_m",
	  opacity: 0,
		color: "#F4A81D",
	  markers: {
  	  visible: true,
  	  background: "#F4A81D",
  	  size: 8
  	},
		tooltip: {
			visible: true,
	    background: "#F4A81D",
			template: "#= category # (#= series.name #): #=  num_spacer(Number(value.toPrecision(2)))  #"
		}
		}],
		valueAxis: {
			labels: {
				format: "{0}"
			},
			title: {
				text: "Prevalence:notification ratio"
			},
			line: {
				visible: false
			}
		},
		categoryAxis: {
			field: "country",
			labels: {
				rotation: "auto"
			},
			majorGridLines: {
				visible: true
			}
		}
	});
}

function createfig_1_4_9(fig_ID, data, color, title) {
   
		$(fig_ID).kendoChart({
			dataSource: data,
			chartArea: {
				height: 900
			},
      
      title: {
				text: title,
				color: "black",
				font: "bold 16px  Arial,Helvetica,sans-serif",
        align: "center"
			},	

			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "bar"
			},
			series: [{
				field: "prop",
				color: color,
				gap: 0.2
			},],
			valueAxis: {
				labels: {
					format: "{0}"
				},
				title: {
					text: "Percentage"
				},
				line: {
					visible: false
				},
				max: 100,
        line: {
                        visible: false
                    },
        plotBands: [
                    {from: 49.9,
                     to: 50.1,
                     color: "black"}
                  ]
			},
			categoryAxis: {
				field: "country",
				labels: {
					rotation: "auto"
				},
				majorGridLines: {
					visible: false
				}
			},
			tooltip: {
				visible: true,
				format: "{0:0.0}%",
				template: "#= category #: #= value.toPrecision(2) #%"
			}
		});
}

```

```{js, echo=FALSE}

/* Create the figures after the document has been loaded */

$(document).ready(function() {
  
  createfig_1_4_3("#fig_1_4_3_africa", fig_1_4_3_data, "Africa", "Africa", "#6363C0");
  createfig_1_4_3("#fig_1_4_3_asia", fig_1_4_3_data, "Asia", "Asia", "#40BF73");
  
  
  create_prev_age("#fig_1_4_4_SWZ", fig_1_4_4_data, "Eswatini");
  create_prev_age("#fig_1_4_4_ETH", fig_1_4_4_data, "Ethiopia");
  create_prev_age("#fig_1_4_4_GMB", fig_1_4_4_data, "Gambia");
  
  create_prev_age("#fig_1_4_4_GHA", fig_1_4_4_data, "Ghana");
  create_prev_age("#fig_1_4_4_KEN", fig_1_4_4_data, "Kenya");
  create_prev_age("#fig_1_4_4_LSO", fig_1_4_4_data, "Lesotho");
  
  create_prev_age("#fig_1_4_4_MWI", fig_1_4_4_data, "Malawi");
  create_prev_age("#fig_1_4_4_MOZ", fig_1_4_4_data, "Mozambique");
  create_prev_age("#fig_1_4_4_NAM", fig_1_4_4_data, "Namibia");
  
  create_prev_age("#fig_1_4_4_NGA", fig_1_4_4_data, "Nigeria");
  create_prev_age("#fig_1_4_4_RWA", fig_1_4_4_data, "Rwanda");
  create_prev_age("#fig_1_4_4_ZAF", fig_1_4_4_data, "South Africa");
  
  create_prev_age("#fig_1_4_4_SDN", fig_1_4_4_data, "Sudan");
  create_prev_age("#fig_1_4_4_UGA", fig_1_4_4_data, "Uganda");
  create_prev_age("#fig_1_4_4_TZA", fig_1_4_4_data, "United Republic of Tanzania");
  
  create_prev_age("#fig_1_4_4_ZMB", fig_1_4_4_data, "Zambia");
  create_prev_age("#fig_1_4_4_ZWE", fig_1_4_4_data, "Zimbabwe", false);
  
  create_prev_age("#fig_1_4_5_BGD", fig_1_4_5_data, "Bangladesh");
  create_prev_age("#fig_1_4_5_KHM", fig_1_4_5_data, "Cambodia");
  create_prev_age("#fig_1_4_5_CHN", fig_1_4_5_data, "China");
  
  create_prev_age("#fig_1_4_5_PRK", fig_1_4_5_data, "Democratic People's Republic of Korea");
  create_prev_age("#fig_1_4_5_IND", fig_1_4_5_data, "India");
  create_prev_age("#fig_1_4_5_IDN", fig_1_4_5_data, "Indonesia");
  
  create_prev_age("#fig_1_4_5_LAO", fig_1_4_5_data, "Lao People's Democratic Republic");
  create_prev_age("#fig_1_4_5_MNG", fig_1_4_5_data, "Mongolia");
  create_prev_age("#fig_1_4_5_MMR09", fig_1_4_5_data, "Myanmar (2009\u20132010)");
  
  create_prev_age("#fig_1_4_5_MMR18", fig_1_4_5_data, "Myanmar (2018)");
  create_prev_age("#fig_1_4_5_NPL", fig_1_4_5_data, "Nepal");
  create_prev_age("#fig_1_4_5_PAK", fig_1_4_5_data, "Pakistan");
  
  create_prev_age("#fig_1_4_5_PHL07", fig_1_4_5_data, "Philippines (2007)");
  create_prev_age("#fig_1_4_5_PHL16", fig_1_4_5_data, "Philippines (2016)");
  create_prev_age("#fig_1_4_5_THA", fig_1_4_5_data, "Thailand");
  
  create_prev_age("#fig_1_4_5_VNM06", fig_1_4_5_data, "Viet Nam (2006\u20132007)");
  create_prev_age("#fig_1_4_5_VNM18", fig_1_4_5_data, "Viet Nam (2018)");
  
  
  create_ratio_bars("#fig_1_4_6", fig_1_4_6_data, "Sex ratio (male:female)", "ratio", "#218CDF");
  
  create_ratio_bars("#fig_1_4_7", fig_1_4_78_data, "Prevalence:notification ratio", "pn", "#FF4500"); 
  
  createfig_1_4_8(); 
  
  createfig_1_4_9("#fig_1_4_9_africa", fig_1_4_9_data_africa, "#6363C0", "Africa"); 
  
  createfig_1_4_9("#fig_1_4_9_asia", fig_1_4_9_data_asia, "#40BF73", "Asia"); 
  
});

```


